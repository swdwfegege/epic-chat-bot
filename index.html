<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nexus Terminal</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
      :root {
        --nexus-glow: rgba(0, 242, 255, 0.5);
        --nexus-bg: #030303;
        --accent: #00f2ff;
        --glass: rgba(255, 255, 255, 0.03);
        --border: rgba(255, 255, 255, 0.1);
        --online: #00ff88;
        --offline: #555;
        --alert: #ff4444;
        .nexus-btn.logout-btn:hover {
  background: var(--alert) !important;
  color: white !important;
  box-shadow: 0 0 15px var(--alert);
}
      }

      body,
      html {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
        background: #000;
        color: white;
        height: 100%;
        overflow: hidden;
      }

      /* --- WATER CHAT OVERLAY --- */
      #water-chat-container {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
      }
      #water-sidebar {
        width: 300px;
        height: 100%;
        background: #050505;
        border-left: 1px solid var(--border);
        display: none;
        flex-direction: column;
      }
      #water-toggle-btn {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        background: var(--accent);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 0 15px var(--accent);
        z-index: 100;
        font-size: 20px;
        color: black;
      }

      /* --- SHOP & UI --- */
      .shop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        padding: 20px;
        width: 80%;
      }
      .shop-item {
        background: var(--glass);
        border: 1px solid var(--border);
        padding: 15px;
        text-align: center;
        border-radius: 8px;
        transition: 0.3s;
      }
      .shop-item:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
      }
      .shop-item.owned {
        border-color: var(--online);
      }
      .bg-preview {
        width: 100%;
        height: 100px;
        border-radius: 4px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background-size: cover !important;
        background-position: center !important;
        position: relative;
      }
      .limited-badge {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(255, 68, 68, 0.9);
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        letter-spacing: 1px;
      }
      .nexus-input {
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border);
        color: white;
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 4px;
        outline: none;
        box-sizing: border-box;
      }
      .nexus-btn {
        width: 100%;
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 10px;
        cursor: pointer;
        transition: 0.3s;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .nexus-btn:hover:not(:disabled) {
        background: var(--accent);
        color: black;
        box-shadow: 0 0 15px var(--accent);
      }
      .nexus-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .nexus-btn.equip-btn {
        border-color: var(--online);
        color: var(--online);
        margin-top: 5px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .dot.online {
        background: var(--online);
        box-shadow: 0 0 10px var(--online);
      }
      .dot.offline {
        background: var(--offline);
      }

      #hub {
        display: none;
        width: 100%;
        height: 100vh;
        flex-direction: column;
        opacity: 0;
        transition: 1s;
      }
      .navbar {
        display: flex;
        justify-content: center;
        gap: 30px;
        padding: 20px 0;
        border-bottom: 1px solid var(--border);
        background: #000;
        z-index: 10;
      }
      .nav-item {
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        font-size: 14px;
        transition: 0.3s;
        position: relative;
        text-transform: lowercase;
      }
      .nav-item.active {
        color: var(--accent);
        text-shadow: 0 0 10px var(--accent);
      }

      .badge {
        position: absolute;
        top: -5px;
        right: -12px;
        background: var(--alert);
        color: white;
        font-size: 9px;
        padding: 2px 5px;
        border-radius: 10px;
        display: none;
        font-weight: bold;
        box-shadow: 0 0 10px var(--alert);
      }
      .contact-item.unread {
        border-left: 3px solid var(--alert);
        background: rgba(255, 68, 68, 0.15);
      }
      #message-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--accent);
        color: white;
        font-size: 14px;
        border-radius: 8px;
        z-index: 10000;
        display: none;
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
      }
      #message-notification.show {
        display: block;
      }

      #manage-group-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
      }
      #manage-group-modal.show {
        display: flex;
      }
      .manage-group-content {
        background: #0a0a0a;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 25px;
        max-width: 400px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .manage-member-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
      }
      .manage-member-item:last-child {
        border-bottom: none;
      }

      .view {
        display: none;
        flex-grow: 1;
        overflow: hidden;
        height: calc(100vh - 65px);
        width: 100%;
      }
      .view.active {
        display: flex;
      }

      /* --- CHAT STYLES --- */
      .chat-layout {
        display: flex;
        width: 100%;
        height: 100%;
      }
      .sidebar {
        width: 280px;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        background: #050505;
        overflow-y: auto;
      }
      .contact-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: 0.2s;
        font-size: 13px;
        display: flex;
        align-items: center;
      }
      .contact-item.selected {
        border-left: 3px solid var(--accent);
        background: rgba(0, 242, 255, 0.1);
      }
      .avatar-circle {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #111;
        border: 1px solid var(--border);
        object-fit: cover;
        margin-right: 12px;
      }
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #000;
        position: relative;
        background-size: cover !important;
        background-position: center !important;
      }
      .chat-msgs-box {
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1;
        background: rgba(0, 0, 0, 0.4);
      }
      .msg {
        padding: 10px 15px;
        border-radius: 8px;
        max-width: 70%;
        font-size: 14px;
        word-wrap: break-word;
        position: relative;
      }
      .msg.user {
        align-self: flex-end;
        background: var(--accent);
        color: #000;
      }
      .msg.other {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border);
        backdrop-filter: blur(5px);
      }
      .msg.system {
        align-self: center;
        background: rgba(0, 242, 255, 0.15);
        border: 1px solid var(--accent);
        font-size: 12px;
        opacity: 0.9;
      }

      .chat-pfp-trigger {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #222;
        margin-bottom: 5px;
        cursor: pointer;
        border: 1px solid var(--border);
        display: block;
      }

      /* --- PROFILE FIX --- */
      .profile-view-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-size: cover !important;
        background-position: center !important;
      }
      .avatar-large {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        border: 2px solid var(--accent);
        margin-bottom: 20px;
        object-fit: cover;
        background: #111;
      }
      .profile-card-ui {
        background: rgba(0, 0, 0, 0.85);
        padding: 40px;
        border-radius: 15px;
        backdrop-filter: blur(15px);
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid var(--border);
        min-width: 320px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      #money-pop {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--online);
        color: black;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: bold;
        display: none;
        z-index: 100;
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* --- SLOT MACHINE STYLES --- */
      .slot-machine {
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .slot-machine:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3);
      }
      .slot-reel {
        transition: all 0.1s;
      }
      .slot-reel.spinning {
        animation: reelSpin 0.1s linear infinite;
        filter: blur(1px);
      }
      @keyframes reelSpin {
        0% { transform: scale(0.95); }
        50% { transform: scale(1.05); }
        100% { transform: scale(0.95); }
      }
      .slot-reel.win {
        animation: reelWin 0.5s ease-out;
        border-color: var(--accent) !important;
        box-shadow: 0 0 20px var(--accent);
      }
      @keyframes reelWin {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
      }
      .slot-display.win {
        animation: displayWin 1s ease-out;
        border-color: var(--online) !important;
        box-shadow: 0 0 30px var(--online);
      }
      @keyframes displayWin {
        0%, 100% { box-shadow: 0 0 30px var(--online); }
        50% { box-shadow: 0 0 60px var(--online), inset 0 0 20px var(--online); }
      }
      #bet-amount:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent);
      }

      .invite-card {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid var(--accent);
      }

      .request-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      #error-message {
        color: var(--alert);
        font-size: 12px;
        margin-top: 10px;
        min-height: 15px;
      }

      @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

#global-notification {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%) translateY(200px);
  width: 580px;
  max-width: 92vw;
  background: #000;
  border: 4px solid #fff;
  box-shadow: 0 0 0 4px #000, 0 0 0 8px #fff, inset 0 0 0 2px #000;
  color: #fff;
  font-family: 'Press Start 2P', monospace;
  font-size: 11px;
  line-height: 1.9;
  z-index: 10000;
  padding: 18px 22px 14px 22px;
  transition: transform 0.35s cubic-bezier(.2,.8,.2,1), opacity 0.3s;
  opacity: 0;
  pointer-events: none;
  image-rendering: pixelated;
}
#global-notification.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  pointer-events: auto;
}
#global-notification.hide {
  transform: translateX(-50%) translateY(200px);
  opacity: 0;
}
#global-notification .ut-speaker {
  color: #ff0;
  font-size: 10px;
  margin-bottom: 8px;
  display: block;
  letter-spacing: 1px;
}
#global-notification .ut-text {
  display: block;
  min-height: 2.2em;
  word-break: break-word;
}
#global-notification .ut-cursor {
  display: inline-block;
  width: 9px;
  height: 13px;
  background: #fff;
  vertical-align: middle;
  margin-left: 2px;
  animation: ut-blink 0.7s steps(1) infinite;
}
@keyframes ut-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
#global-notification .ut-arrow {
  display: block;
  text-align: right;
  color: #fff;
  font-size: 9px;
  margin-top: 6px;
  animation: ut-bounce 0.6s steps(1) infinite;
}
@keyframes ut-bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(3px); }
}
      /* Image popup + flashbang animation */
      #image-popup { position: fixed; inset: 0; display: none; z-index: 10002; }
      #image-popup-backdrop { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; }
      #image-popup-img { max-width: 100vw; max-height: 100vh; width: 100vw; height: 100vh; object-fit: contain; border-radius: 0; box-shadow: none; transition: transform 0.45s cubic-bezier(.2,.8,.2,1), opacity 0.3s; }
      #image-popup-flash { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: white; opacity: 0; pointer-events: none; z-index: 10003; }
      #image-popup-flash.flash-animate { animation: flashAnim 700ms ease-out; }
      @keyframes flashAnim {
        0% { opacity: 0; filter: brightness(1); }
        20% { opacity: 1; filter: brightness(4); }
        60% { opacity: 0.6; filter: brightness(2); }
        100% { opacity: 0; filter: brightness(1); }
      }
      #image-popup-img.pop-animate { animation: popIn 600ms cubic-bezier(.2,.8,.2,1); }
      @keyframes popIn {
        0% { transform: scale(0.92); opacity: 0.8; }
        60% { transform: scale(1.06); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }
    </style>
  </head>

  <body onload="init()">
    <div id="money-pop">+1 Nexus Credit</div>
<body onload="init()">
  <audio id="profile-audio" preload="auto">
    <source src="Greenday_-_American_Idiot_(mp3.pm).mp3" type="audio/mpeg">
  </audio>
  <audio id="profile-music-player" preload="auto" loop></audio>
    <div id="money-pop">+1 Nexus Credit</div>
    <div id="global-notification">
      <span class="ut-speaker">* dom :</span>
      <span class="ut-text" id="ut-notif-text"><span class="ut-cursor"></span></span>
      <span class="ut-arrow">‚ñº</span>
    </div>
    <div id="image-popup" onclick="hideImagePopup()" style="display:none;">
      <div id="image-popup-backdrop" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10002;">
        <img id="image-popup-img" src="" style="max-width:100vw;max-height:100vh;width:100vw;height:100vh;object-fit:contain;border-radius:0;box-shadow:none;" />
      </div>
    </div>
    <div id="image-popup-flash"></div>
    <div id="message-notification">you have a message</div>
    <!-- TRADE OFFER MODAL -->
<div id="trade-modal" style="display:none;position:fixed;inset:0;z-index:10006;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);" onclick="if(event.target===this)closeTradeModal()">
  <div style="background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;width:600px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;">
    <div style="padding:15px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:space-between;">
      <span style="color:#00f2ff;font-size:13px;letter-spacing:2px;">üîÑ TRADE REQUEST</span>
      <span onclick="closeTradeModal()" style="cursor:pointer;opacity:0.5;font-size:20px;">‚úï</span>
    </div>
    <div style="display:flex;flex:1;overflow:hidden;">
      <!-- YOUR OFFER SIDE -->
      <div style="flex:1;padding:15px;border-right:1px solid rgba(255,255,255,0.1);overflow-y:auto;">
        <div style="font-size:10px;color:#00f2ff;letter-spacing:2px;margin-bottom:12px;">YOUR OFFER</div>
        <!-- Credits -->
        <div style="margin-bottom:12px;">
          <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">CREDITS</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <input type="number" id="trade-my-credits" class="nexus-input" style="margin:0;padding:8px;font-size:12px;" placeholder="0" min="0" />
          </div>
        </div>
        <!-- Backgrounds -->
        <div style="margin-bottom:12px;">
          <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">BACKGROUNDS</div>
          <div id="trade-my-bgs" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;"></div>
          <button class="nexus-btn" onclick="openTradeItemPicker('bg','my')" style="width:auto;padding:5px 12px;font-size:10px;">+ Add Background</button>
        </div>
        <!-- Music -->
        <div>
          <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">PROFILE MUSIC</div>
          <div id="trade-my-music" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;"></div>
          <button class="nexus-btn" onclick="openTradeItemPicker('music','my')" style="width:auto;padding:5px 12px;font-size:10px;">+ Add Music</button>
        </div>
      </div>
      <!-- THEIR OFFER SIDE -->
      <div style="flex:1;padding:15px;overflow-y:auto;">
        <div style="font-size:10px;color:#00ff88;letter-spacing:2px;margin-bottom:12px;">YOU WANT (from <span id="trade-target-name"></span>)</div>
        <!-- Credits -->
        <div style="margin-bottom:12px;">
          <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">CREDITS</div>
          <input type="number" id="trade-their-credits" class="nexus-input" style="margin:0;padding:8px;font-size:12px;" placeholder="0" min="0" />
        </div>
        <!-- Backgrounds -->
        <div style="margin-bottom:12px;">
          <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">BACKGROUNDS</div>
          <div id="trade-their-bgs" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;"></div>
          <button class="nexus-btn" onclick="openTradeItemPicker('bg','their')" style="width:auto;padding:5px 12px;font-size:10px;">+ Add Background</button>
        </div>
        <!-- Music -->
        <div>
          <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">PROFILE MUSIC</div>
          <div id="trade-their-music" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;"></div>
          <button class="nexus-btn" onclick="openTradeItemPicker('music','their')" style="width:auto;padding:5px 12px;font-size:10px;">+ Add Music</button>
        </div>
      </div>
    </div>
    <div style="padding:15px 20px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;justify-content:flex-end;">
      <button class="nexus-btn" onclick="closeTradeModal()" style="width:auto;padding:10px 20px;border-color:#555;color:#555;">Cancel</button>
      <button class="nexus-btn" onclick="sendTradeRequest()" style="width:auto;padding:10px 20px;">Send Trade</button>
    </div>
  </div>
</div>

<!-- ITEM PICKER MODAL -->
<div id="trade-picker-modal" style="display:none;position:fixed;inset:0;z-index:10007;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);" onclick="if(event.target===this)closeTradePickerModal()">
  <div style="background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;width:450px;max-width:95vw;max-height:70vh;display:flex;flex-direction:column;overflow:hidden;">
    <div style="padding:15px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;">
      <span id="picker-title" style="color:#00f2ff;font-size:12px;letter-spacing:2px;">SELECT ITEM</span>
      <span onclick="closeTradePickerModal()" style="cursor:pointer;opacity:0.5;font-size:20px;">‚úï</span>
    </div>
    <div id="picker-items" style="flex:1;overflow-y:auto;padding:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px;"></div>
  </div>
</div>
    <div id="gif-modal" style="display:none;position:fixed;inset:0;z-index:10005;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);" onclick="if(event.target===this)closeGifModal()">
      <div style="background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;width:500px;max-width:95vw;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;">
        <div style="padding:15px 18px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:10px;">
          <span style="font-size:20px;">üé¨</span>
          <input
            type="text"
            id="gif-search-input"
            placeholder="Search GIFs..."
            style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:white;padding:8px 12px;border-radius:6px;outline:none;font-size:13px;"
            onkeydown="if(event.key==='Enter')searchGifs()"
          />
          <button class="nexus-btn" onclick="searchGifs()" style="width:auto;padding:8px 14px;font-size:11px;">Search</button>
          <span onclick="closeGifModal()" style="cursor:pointer;opacity:0.5;font-size:20px;line-height:1;margin-left:4px;">‚úï</span>
        </div>
        <div id="gif-results" style="flex:1;overflow-y:auto;padding:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;min-height:200px;">
          <div id="gif-placeholder" style="grid-column:1/-1;text-align:center;opacity:0.4;padding:40px;font-size:13px;">Search for a GIF above</div>
        </div>
        <div id="gif-loading" style="display:none;text-align:center;padding:20px;opacity:0.5;font-size:12px;">Loading...</div>
      </div>
    </div>
    <div id="members-panel" style="position:fixed;top:0;right:-320px;width:300px;height:100vh;background:#050505;border-left:1px solid rgba(255,255,255,0.1);z-index:9999;display:flex;flex-direction:column;transition:right 0.3s ease;">
      <div style="padding:15px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;">
        <span id="members-panel-title" style="font-size:11px;color:#00f2ff;letter-spacing:2px;">MEMBERS</span>
        <span onclick="closeMembersPanel()" style="cursor:pointer;opacity:0.5;font-size:18px;line-height:1;">‚úï</span>
      </div>
      <div style="flex:1;overflow-y:auto;padding:10px;">
        <div style="font-size:9px;color:#00ff88;letter-spacing:2px;margin:8px 0 6px 4px;">ONLINE</div>
        <div id="members-online-list"></div>
        <div style="font-size:9px;color:#555;letter-spacing:2px;margin:14px 0 6px 4px;">OFFLINE</div>
        <div id="members-offline-list"></div>
      </div>
    </div>
    <div id="members-panel-backdrop" onclick="closeMembersPanel()" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9998;display:none;"></div>
    <div id="manage-group-modal" onclick="if(event.target===this) closeManageGroupModal()">
      <div class="manage-group-content" onclick="event.stopPropagation()">
        <h3 style="margin-top: 0; letter-spacing: 2px;">manage group</h3>
        <div id="manage-group-members"></div>
        <button class="nexus-btn" style="margin-top: 15px; width: auto;" onclick="closeManageGroupModal()">Close</button>
      </div>
    </div>

    <!-- Animated Wave Background -->
    <div class="wave-bg">
      <div class="wave wave-1"></div>
      <div class="wave wave-2"></div>
      <div class="wave wave-3"></div>
      <div class="wave-lines">
        <svg viewBox="0 0 1200 800" preserveAspectRatio="none">
          <path class="flow-line line-1" d="M0,400 Q300,300 600,400 T1200,400" />
          <path class="flow-line line-2" d="M0,450 Q300,350 600,450 T1200,450" />
          <path class="flow-line line-3" d="M0,350 Q300,250 600,350 T1200,350" />
          <path class="flow-line line-4" d="M0,500 Q300,400 600,500 T1200,500" />
          <path class="flow-line line-5" d="M0,300 Q300,200 600,300 T1200,300" />
        </svg>
      </div>
    </div>

    <style>
      .gif-thumb {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border-color 0.2s, transform 0.2s;
  background: #111;
}
.gif-thumb:hover {
  border-color: var(--accent);
  transform: scale(1.03);
}
.msg-gif {
  max-width: 100%;
  width: 240px;
  border-radius: 8px;
  display: block;
  margin-top: 4px;
}
      .member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 7px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
  margin-bottom: 2px;
}
.member-item:hover {
  background: rgba(255,255,255,0.06);
}
.member-item .member-pfp {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #333;
  flex-shrink: 0;
  transition: filter 0.2s;
}
.member-item.offline-member .member-pfp {
  filter: grayscale(100%) brightness(0.5);
  border-color: #333;
}
.member-item .member-name {
  font-size: 12px;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.member-item.offline-member .member-name {
  color: #555;
}
.member-status-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}
      .wave-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
        overflow: hidden;
      }
      
      .wave {
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(ellipse at center, rgba(0, 242, 255, 0.03) 0%, transparent 70%);
        animation: wave-rotate 20s linear infinite;
      }
      
      .wave-1 {
        top: -50%;
        left: -50%;
        animation-delay: 0s;
      }
      
      .wave-2 {
        top: -50%;
        left: -50%;
        animation-delay: -7s;
        animation-duration: 25s;
      }
      
      .wave-3 {
        top: -50%;
        left: -50%;
        animation-delay: -14s;
        animation-duration: 30s;
      }
      
      @keyframes wave-rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .wave-lines {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.4;
      }
      
      .wave-lines svg {
        width: 100%;
        height: 100%;
      }
      
      .flow-line {
        fill: none;
        stroke: var(--accent);
        stroke-width: 1.5;
        stroke-linecap: round;
        filter: drop-shadow(0 0 3px rgba(0, 242, 255, 0.5));
      }
      
      .line-1 { animation: flow 8s ease-in-out infinite; }
      .line-2 { animation: flow 10s ease-in-out infinite; animation-delay: -2s; }
      .line-3 { animation: flow 12s ease-in-out infinite; animation-delay: -4s; }
      .line-4 { animation: flow 9s ease-in-out infinite; animation-delay: -6s; }
      .line-5 { animation: flow 11s ease-in-out infinite; animation-delay: -8s; }
      
      @keyframes flow {
        0%, 100% {
          d: path("M0,400 Q300,300 600,400 T1200,400");
        }
        25% {
          d: path("M0,400 Q300,500 600,400 T1200,400");
        }
        50% {
          d: path("M0,400 Q300,300 600,400 T1200,400");
        }
        75% {
          d: path("M0,400 Q300,500 600,400 T1200,400");
        }
      }
      
      /* Adjust line animations for different starting positions */
      .line-2 { 
        animation-name: flow2;
        stroke: rgba(0, 255, 136, 0.6);
      }
      @keyframes flow2 {
        0%, 100% { d: path("M0,450 Q300,350 600,450 T1200,450"); }
        25% { d: path("M0,450 Q300,550 600,450 T1200,450"); }
        50% { d: path("M0,450 Q300,350 600,450 T1200,450"); }
        75% { d: path("M0,450 Q300,550 600,450 T1200,450"); }
      }
      
      .line-3 { 
        animation-name: flow3;
        stroke: rgba(255, 0, 242, 0.4);
      }
      @keyframes flow3 {
        0%, 100% { d: path("M0,350 Q300,250 600,350 T1200,350"); }
        25% { d: path("M0,350 Q300,450 600,350 T1200,350"); }
        50% { d: path("M0,350 Q300,250 600,350 T1200,350"); }
        75% { d: path("M0,350 Q300,450 600,350 T1200,350"); }
      }
      
      .line-4 { 
        animation-name: flow4;
        stroke: rgba(0, 242, 255, 0.5);
      }
      @keyframes flow4 {
        0%, 100% { d: path("M0,500 Q300,400 600,500 T1200,500"); }
        25% { d: path("M0,500 Q300,600 600,500 T1200,500"); }
        50% { d: path("M0,500 Q300,400 600,500 T1200,500"); }
        75% { d: path("M0,500 Q300,600 600,500 T1200,500"); }
      }
      
      .line-5 { 
        animation-name: flow5;
        stroke: rgba(255, 170, 0, 0.3);
      }
      @keyframes flow5 {
        0%, 100% { d: path("M0,300 Q300,200 600,300 T1200,300"); }
        25% { d: path("M0,300 Q300,400 600,300 T1200,300"); }
        50% { d: path("M0,300 Q300,200 600,300 T1200,300"); }
        75% { d: path("M0,300 Q300,400 600,300 T1200,300"); }
      }
    </style>

    <div
      id="welcome-screen"
      style="
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        background: transparent;
      "
    >
      <div
        id="terminal-container"
        style="
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(5px);
          padding: 0;
          font-family: 'Consolas', 'Courier New', monospace;
          position: relative;
          margin: 0;
          overflow: hidden;
        "
      >
        <div id="terminal-output" style="color: #00ff00; font-size: 16px; line-height: 1.2; height: calc(100vh - 30px); overflow-y: auto; padding: 10px; margin: 0; white-space: pre-wrap;">
          <div id="terminal-text"></div>
          <div id="loading-messages" style="display: none;"></div>
          <div id="username-input-area" style="display: none;">
            <br><span style="color: #00ff00;">enter a username and hit enter</span><br>
            <span style="color: #00ff00;">C:\\Users\\Nexus&gt;</span> 
            <input 
              type="text" 
              id="terminal-username-input" 
              style="
                background: transparent; 
                border: none; 
                color: #00ff00; 
                font-family: 'Consolas', 'Courier New', monospace; 
                font-size: 16px; 
                outline: none; 
                caret-color: #00ff00;
                width: 200px;
              "
              autocomplete="off"
            />
            <span id="terminal-cursor" style="background: #00ff00; width: 8px; height: 18px; display: inline-block; animation: blink 1s infinite; vertical-align: text-bottom;"></span>
          </div>
        </div>
      </div>

      <input type="text" id="username-input" style="display: none;" />
    </div>

    <style>
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .color-option:hover {
        transform: scale(1.1);
        box-shadow: 0 0 15px currentColor;
      }
      
      .color-option.selected {
        border-color: white !important;
        transform: scale(1.15);
        box-shadow: 0 0 20px currentColor;
      }
    </style>

    <div id="hub">
      <nav class="navbar">
        <div class="nav-item" onclick="tab('water')">water</div>
        <div class="nav-item" onclick="tab('chat')" style="position: relative;">
          chat <span id="chat-badge" class="badge">!</span>
        </div>
        <div class="nav-item" onclick="tab('shop')">shop</div>
        <div class="nav-item" onclick="tab('inventory')">inventory</div>
 <div class="nav-item" onclick="tab('search')">search</div>
<div class="nav-item" onclick="tab('leaderboards')">leaderboards</div>
        <div class="nav-item" onclick="tab('games')">games</div>
        <div class="nav-item" onclick="tab('gambling')">gambling</div>
        <div class="nav-item" onclick="tab('security')">security <span id="security-badge" class="badge" style="display: none;">!</span></div>
        <div id="nav-admin" class="nav-item" onclick="tab('admin')" style="display: none;">admin</div>
        <div class="nav-item" onclick="viewProfile(window.myName)">
          my profile <span id="notif-badge" class="badge">!</span>
        </div>
      </nav>
      <div
        id="switch-dom-tab"
        class="nav-item"
        onclick="switchAccount('dom')"
        style="display: none; color: var(--alert)"
      >
        switch to dom
      </div>

      <div id="water" class="view">
        <div id="water-chat-container">
          <iframe
            id="water-frame"
            src=""
            style="flex: 1; border: none"
          ></iframe>
          <div id="water-toggle-btn" onclick="toggleWaterChat()">üí¨</div>
          <div id="water-sidebar">
            <div
              style="
                padding: 10px;
                font-size: 11px;
                color: var(--accent);
                text-align: center;
                border-bottom: 1px solid var(--border);
              "
            >
              ACTIVE TERMINAL
            </div>
            <div id="water-chat-inner" class="chat-main" style="height: 100%">
              <div id="water-msgs" class="chat-msgs-box"></div>
              <div style="padding: 10px; border-top: 1px solid var(--border)">
                <input
                  type="text"
                  id="water-chat-input"
                  class="nexus-input"
                  style="margin: 0; padding: 8px"
                  placeholder="Message..."
                  maxlength="212"
                  onkeydown="if(event.key==='Enter')sendMsg('water')"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="chat" class="view active">
        <div class="chat-layout">
          <div class="sidebar">
            <div
              style="
                padding: 15px;
                font-size: 11px;
                opacity: 0.5;
                letter-spacing: 2px;
              "
            >
              CHANNELS
            </div>
            <div id="chatroom-list">
              <div
                class="contact-item"
                data-chat-id="GLOBAL_CHAT"
                onclick="openChat('Live Chatroom', this, 'global')"
              >
                <div
                  class="avatar-circle"
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: var(--accent);
                    color: black;
                    font-weight: bold;
                  "
                >
                  #
                </div>
                <span>Live Chatroom</span>
              </div>
            </div>
            <div
              style="
                padding: 15px;
                font-size: 11px;
                opacity: 0.5;
                letter-spacing: 2px;
                border-top: 1px solid var(--border);
              "
            >
              GROUPS
            </div>
            <div id="group-list"></div>
            <div
              style="
                padding: 15px;
                font-size: 11px;
                opacity: 0.5;
                letter-spacing: 2px;
                border-top: 1px solid var(--border);
              "
            >
              CONTACTS
            </div>
            <input
              type="text"
              id="friend-search"
              placeholder="Search friends..."
              onkeyup="filterFriends()"
              style="
                margin: 0 15px 10px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid var(--border);
                color: white;
                padding: 5px;
                font-size: 12px;
              "
            />
            <div id="friend-list"></div>
            <button
              class="nexus-btn"
              style="
                margin-top: auto;
                border: none;
                background: rgba(255, 255, 255, 0.05);
              "
              onclick="addFriend()"
            >
              + Add Friend
            </button>
          </div>
          <div id="chat-pane" class="chat-main">
            <div
              id="chat-header"
              style="
                padding: 10px 25px;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2;
              "
            >
              <img
                id="header-pfp"
                class="avatar-circle"
                style="display: none; cursor: pointer"
                onclick="groupInviteAction()"
              />
              <div
                id="active-chat-user"
                style="font-size: 12px; color: var(--accent); flex: 1"
              >
                Select a contact
              </div>
              <button
                id="make-group-btn"
                class="nexus-btn"
                style="
                  width: auto;
                  font-size: 10px;
                  margin-right: 10px;
                  display: none;
                "
                onclick="createGroup()"
              >
                make a groupchat?
              </button>
              <button
                id="manage-group-btn"
                class="nexus-btn"
                style="
                  width: auto;
                  font-size: 10px;
                  margin-right: 10px;
                  display: none;
                "
                onclick="manageGroup()"
              >
                Manage
              </button>
              <button
                id="mute-notif-btn"
                class="nexus-btn"
                style="width: auto; font-size: 10px; margin-right: 5px; display: none;"
                onclick="toggleMuteNotifications()"
                title="Mute notifications for this chat"
              >
              <button
              id="members-btn"
              class="nexus-btn"
              style="width:auto;font-size:10px;margin-right:8px;display:none;"
              onclick="openMembersPanel()"
            >
              üë• Members
            </button>
            <div
              onclick="changeChatBG()"
              style="cursor: pointer; opacity: 0.5; font-size: 18px"
              title="Change Chat Background"
            >
              ‚öôÔ∏è
            </div>
            </div>
            <div id="chat-msgs" class="chat-msgs-box"></div>
            <div
              style="
                padding: 20px;
                border-top: 1px solid var(--border);
                background: rgba(0, 0, 0, 0.8);
                z-index: 2;
              "
            >
            <div style="display:flex;align-items:center;gap:8px;">
              <button onclick="openGifModal()" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.6);padding:10px 12px;cursor:pointer;border-radius:4px;font-size:14px;transition:0.2s;flex-shrink:0;" title="Send a GIF" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.2)';this.style.color='rgba(255,255,255,0.6)'">GIF</button>
              <input
                type="text"
                id="chat-input"
                class="nexus-input"
                style="margin:0;flex:1;"
                placeholder="Message..."
                maxlength="212"
                onkeydown="if(event.key==='Enter')sendMsg()"
              />
            </div>
            </div>
          </div>
        </div>
      </div>

      <div
        id="shop"
        class="view"
        style="flex-direction: column; align-items: center; overflow-y: auto"
      >
        <h2 style="margin-top: 30px; letter-spacing: 3px">goated shop</h2>
        <div style="color: var(--accent); margin-bottom: 20px">
          Balance: <span id="shop-balance">0</span> NC
        </div>
        <div class="shop-grid" id="shop-items-container"></div>
      </div>

      <div id="inventory" class="view" style="flex-direction: column; align-items: center; overflow-y: auto">
        <h2 style="margin-top: 30px; letter-spacing: 3px">inventory</h2>
        <p style="font-size: 12px; opacity: 0.7; margin-bottom: 20px">backgrounds you own</p>
        <div class="shop-grid" id="inventory-items-container"></div>
      </div>
      <div id="search" class="view" style="flex-direction:column;align-items:center;padding:40px;overflow-y:auto;">
  <h2 style="letter-spacing:3px;margin-bottom:20px;">find users</h2>
  <input
    type="text"
    id="user-search-input"
    class="nexus-input"
    style="max-width:400px;margin-bottom:20px;"
    placeholder="Search by username..."
    oninput="searchUsers()"
  />
  <div id="user-search-results" style="width:100%;max-width:600px;display:flex;flex-direction:column;gap:10px;"></div>
</div>

      <div id="leaderboards" class="view" style="flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;">
        <h2 style="letter-spacing: 3px; margin-bottom: 30px;">leaderboards</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; width: 100%; max-width: 1200px;">
          <!-- Credits Leaderboard -->
          <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
            <h3 style="color: var(--accent); margin-top: 0; text-align: center; letter-spacing: 2px;">üí∞ Top Credits</h3>
            <div id="credits-leaderboard" style="display: flex; flex-direction: column; gap: 10px;"></div>
          </div>
          
          <!-- Time Played Leaderboard -->
          <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
            <h3 style="color: var(--accent); margin-top: 0; text-align: center; letter-spacing: 2px;">‚è±Ô∏è Time Played</h3>
            <div id="time-leaderboard" style="display: flex; flex-direction: column; gap: 10px;"></div>
          </div>
          
          <!-- Backgrounds Leaderboard -->
          <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
            <h3 style="color: var(--accent); margin-top: 0; text-align: center; letter-spacing: 2px;">üé® Most Backgrounds</h3>
            <div id="backgrounds-leaderboard" style="display: flex; flex-direction: column; gap: 10px;"></div>
          </div>
        </div>
      </div>

      <div id="games" class="view" style="flex-direction: column; height: 100%; padding: 0; overflow: hidden;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: var(--glass); border-bottom: 1px solid var(--border);">
          <div style="display: flex; align-items: center; gap: 15px;">
            <button class="nexus-btn" onclick="returnToGamesSelection()" style="width: auto; padding: 8px 15px; font-size: 12px;">
              ‚Üê Back
            </button>
            <span style="font-size: 16px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent);">games</span>
          </div>
        </div>
        
        <div id="game-content" style="flex: 1; display: flex; flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;">
          <h2 style="letter-spacing: 3px; margin-bottom: 30px;">select a game</h2>
          <div id="games-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 100%; max-width: 1000px;">
            <!-- Game 1 -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">retro bowl</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">retro bowl</h3>
                <button class="nexus-btn" onclick="launchGame('retro bowl', 'Retro Bowl', 'Retro Bowl.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
            
            <!-- Game 2 -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #2e1a2e 0%, #1e1621 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">stein</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">5 nights at the steins</h3>
                <button class="nexus-btn" onclick="launchGame('game2', 'Game 2', 'stein.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
            
            <!-- Game 3 -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #1e2e1e 0%, #162116 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">buster</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">buster jam</h3>
                <button class="nexus-btn" onclick="launchGame('game3', 'Game 3', 'Buster Jam.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
                        <!-- Game 4 -->
                        <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
                          <div style="height: 150px; background: linear-gradient(135deg, #2e1a2e 0%, #1e1621 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                            <span style="font-size: 48px;">crazy cattle 3d</span>
                          </div>
                          <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">crazy cattle</h3>
                            <button class="nexus-btn" onclick="launchGame('game2', 'Game 2', 'Crazy Cattle 3D.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                              ‚ñ∂ Play
                            </button>
                          </div>
                        </div>
          </div>
        </div>
      </div>

      <div id="gambling" class="view" style="flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;">
        <h2 style="letter-spacing: 3px; margin-bottom: 30px;">gambling</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; width: 100%; max-width: 900px;">
          <!-- Free Slot Machine -->
          <div class="slot-machine" style="background: var(--glass); border: 2px solid var(--border); border-radius: 15px; padding: 30px; text-align: center;">
            <h3 style="color: var(--accent); margin-bottom: 20px; letter-spacing: 2px;">üé∞ Practice Slots</h3>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 20px;">Free to play - no rewards</p>
            
            <div class="slot-display" id="free-slot-display" style="background: #000; border: 3px solid var(--accent); border-radius: 10px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px;">
              <div class="slot-reel" id="free-reel-1" style="width: 60px; height: 60px; background: #111; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px;">üé∞</div>
              <div class="slot-reel" id="free-reel-2" style="width: 60px; height: 60px; background: #111; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px;">üé∞</div>
              <div class="slot-reel" id="free-reel-3" style="width: 60px; height: 60px; background: #111; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px;">üé∞</div>
            </div>
            
            <div id="free-result" style="min-height: 24px; margin-bottom: 15px; font-size: 14px;"></div>
            <button class="nexus-btn" onclick="spinFreeSlot()" id="free-spin-btn" style="width: auto; padding: 12px 30px;">SPIN</button>
          </div>
          
          <!-- Betting Slot Machine -->
          <div class="slot-machine" style="background: var(--glass); border: 2px solid var(--accent); border-radius: 15px; padding: 30px; text-align: center; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);">
            <h3 style="color: var(--accent); margin-bottom: 20px; letter-spacing: 2px;">üí∞ High Stakes Slots</h3>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 20px;">Bet credits - Win 2x or 3x your bet!</p>
            
            <div style="margin-bottom: 15px;">
              <label style="font-size: 12px; opacity: 0.7;">Bet Amount:</label>
              <input type="number" id="bet-amount" class="nexus-input" style="width: 120px; margin-left: 10px; text-align: center;" value="100" min="10" max="10000">
            </div>
            
            <div class="slot-display" id="bet-slot-display" style="background: #000; border: 3px solid var(--accent); border-radius: 10px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px;">
              <div class="slot-reel" id="bet-reel-1" style="width: 60px; height: 60px; background: #111; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px;">üíé</div>
              <div class="slot-reel" id="bet-reel-2" style="width: 60px; height: 60px; background: #111; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px;">üíé</div>
              <div class="slot-reel" id="bet-reel-3" style="width: 60px; height: 60px; background: #111; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px;">üíé</div>
            </div>
            
            <div id="bet-result" style="min-height: 24px; margin-bottom: 15px; font-size: 14px;"></div>
            <button class="nexus-btn" onclick="spinBetSlot()" id="bet-spin-btn" style="width: auto; padding: 12px 30px; background: linear-gradient(135deg, var(--accent), var(--online));">SPIN (<span id="current-bet">100</span> credits)</button>
          </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center; opacity: 0.6; font-size: 12px;">
          <p>üíéüíéüíé = 3x Win | üçÄüçÄüçÄ = 2x Win | 7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£ = Jackpot 5x</p>
        </div>
      </div>

      <div id="security" class="view" style="flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;">
        <h2 style="letter-spacing: 3px; margin-bottom: 30px;">security</h2>
        
        <div class="security-container" style="background: var(--glass); border: 1px solid var(--border); border-radius: 15px; padding: 30px; max-width: 400px; width: 100%;">
          <h3 style="color: var(--accent); margin-bottom: 20px; letter-spacing: 2px; text-align: center;">üîê Account PIN</h3>
          
          <div id="pin-status" style="text-align: center; margin-bottom: 20px; font-size: 14px;">
            Checking PIN status...
          </div>
          
          <div id="pin-setup-section" style="display: none;">
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px; text-align: center;">
              Set a 4-digit PIN to protect your account. You'll need to enter this PIN when logging in.
            </p>
            <input
              type="password"
              id="new-pin-input"
              class="nexus-input"
              style="max-width: 200px; margin: 0 auto 15px auto; display: block; text-align: center; letter-spacing: 8px;"
              placeholder="0000"
              maxlength="4"
              pattern="[0-9]{4}"
              inputmode="numeric"
            />
            <input
              type="password"
              id="confirm-pin-input"
              class="nexus-input"
              style="max-width: 200px; margin: 0 auto 15px auto; display: block; text-align: center; letter-spacing: 8px;"
              placeholder="Confirm PIN"
              maxlength="4"
              pattern="[0-9]{4}"
              inputmode="numeric"
            />
            <button class="nexus-btn" onclick="setPin()" style="width: auto; padding: 12px 30px; margin: 0 auto; display: block;">Set PIN</button>
          </div>
          
          <div id="pin-change-section" style="display: none;">
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px; text-align: center;">
              You already have a PIN set. Enter your current PIN to change it.
            </p>
            <input
              type="password"
              id="current-pin-input"
              class="nexus-input"
              style="max-width: 200px; margin: 0 auto 15px auto; display: block; text-align: center; letter-spacing: 8px;"
              placeholder="Current PIN"
              maxlength="4"
              pattern="[0-9]{4}"
              inputmode="numeric"
            />
            <input
              type="password"
              id="new-change-pin-input"
              class="nexus-input"
              style="max-width: 200px; margin: 0 auto 15px auto; display: block; text-align: center; letter-spacing: 8px;"
              placeholder="New PIN"
              maxlength="4"
              pattern="[0-9]{4}"
              inputmode="numeric"
            />
            <button class="nexus-btn" onclick="changePin()" style="width: auto; padding: 12px 30px; margin: 0 auto 10px auto; display: block;">Change PIN</button>
            <button class="nexus-btn" onclick="removePin()" style="width: auto; padding: 10px 20px; margin: 0 auto; display: block; background: transparent; border-color: var(--alert); color: var(--alert); font-size: 12px;">Remove PIN</button>
          </div>
          
          <div id="pin-feedback" style="text-align: center; margin-top: 15px; font-size: 13px; min-height: 20px;"></div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; opacity: 0.6; font-size: 11px; max-width: 400px;">
          <p>üí° Tip: Without a PIN, anyone can log into your account if they know your username.</p>
        </div>
      </div>

      <div id="admin" class="view" style="flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;">
        <h2 style="letter-spacing: 2px; margin-bottom: 20px;">ban someone</h2>
        <input
          type="text"
          id="ban-username-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 15px;"
          placeholder="Enter username to ban"
          onkeydown="if(event.key==='Enter') banUser()"
        />
        <button class="nexus-btn" onclick="banUser()" style="width: auto; padding: 10px 25px;">Ban</button>
        <div id="ban-feedback" style="margin-top: 15px; font-size: 12px; color: var(--accent); min-height: 20px;"></div>

        <h2 style="letter-spacing: 2px; margin: 40px 0 20px;">global message</h2>
        <input
          type="text"
          id="global-message-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 15px;"
          placeholder="Send a global notification"
          onkeydown="if(event.key==='Enter') sendGlobalMessage()"
        />

        <h2 style="letter-spacing: 2px; margin: 40px 0 20px;">limited skins</h2>
        <input
          type="text"
          id="limited-name-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 10px;"
          placeholder="Background name"
        />
        <input
          type="file"
          id="limited-image-input"
          accept="image/*"
          style="display: none;"
          onchange="handleLimitedImage(this)"
        />
        <button class="nexus-btn" onclick="document.getElementById('limited-image-input').click()" style="width: auto; padding: 10px 20px; margin-bottom: 10px;">
          Choose background image
        </button>
        <div id="limited-image-preview" style="max-width: 150px; max-height: 80px; margin-bottom: 10px; border-radius: 4px; overflow: hidden; display: none;">
          <img id="limited-preview-img" style="width: 100%; height: auto; display: block;" />
        </div>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
          <input
            type="number"
            id="limited-duration-input"
            class="nexus-input"
            style="max-width: 100px; margin-bottom: 0;"
            placeholder="Duration"
            min="1"
          />
          <select id="limited-duration-unit" class="nexus-input" style="max-width: 100px; margin-bottom: 0;">
            <option value="minutes">minutes</option>
            <option value="hours">hours</option>
          </select>
        </div>
        <input
          type="number"
          id="limited-price-input"
          class="nexus-input"
          style="max-width: 120px; margin-bottom: 10px;"
          placeholder="Price (NC)"
          min="0"
          value="0"
        />
        <button class="nexus-btn" onclick="submitLimitedSkin()" style="width: auto; padding: 10px 25px;">Add to shop</button>
        <div id="limited-feedback" style="margin-top: 10px; font-size: 12px; color: var(--accent); min-height: 20px;"></div>
        
        <h2 style="letter-spacing: 2px; margin: 40px 0 20px;">give credits</h2>
        <input
          type="text"
          id="credit-username-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 10px;"
          placeholder="Enter username to credit"
          onkeydown="if(event.key==='Enter') giveCredits()"
        />
        <input
          type="number"
          id="credit-amount-input"
          class="nexus-input"
          style="max-width: 150px; margin-bottom: 10px;"
          placeholder="Amount"
          min="1"
        />
        <button class="nexus-btn" onclick="giveCredits()" style="width: auto; padding: 10px 25px;">Give Credits</button>
        <div id="credit-feedback" style="margin-top: 12px; font-size: 13px; color: var(--accent); min-height: 20px;"></div>
        
        <h2 style="letter-spacing: 2px; margin: 40px 0 20px;">show image popup</h2>
        <input
          type="text"
          id="popup-target-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 10px;"
          placeholder="Enter username or 'everyone'"
          onkeydown="if(event.key==='Enter') triggerImagePopup()"
        />
        <input
          type="number"
          id="popup-duration-input"
          class="nexus-input"
          style="max-width: 150px; margin-bottom: 10px;"
          placeholder="Duration (seconds)"
          min="1"
          value="5"
        />
        <input
          type="text"
          id="popup-url-input"
          class="nexus-input"
          style="max-width: 500px; margin-bottom: 10px;"
          placeholder="Image URL"
          onkeydown="if(event.key==='Enter') triggerImagePopup()"
        />
        <button class="nexus-btn" onclick="triggerImagePopup()" style="width: auto; padding: 10px 25px;">Show Image</button>
        <div id="popup-feedback" style="margin-top: 12px; font-size: 13px; color: var(--accent); min-height: 20px;"></div>
        
        <h2 style="letter-spacing: 2px; margin: 40px 0 20px;">set slot luck</h2>
        <input
          type="text"
          id="luck-username-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 10px;"
          placeholder="Enter username to modify luck"
          onkeydown="if(event.key==='Enter') setUserLuck()"
        />
        <input
          type="number"
          id="luck-value-input"
          class="nexus-input"
          style="max-width: 150px; margin-bottom: 10px;"
          placeholder="Luck multiplier"
          min="0.1"
          max="10"
          step="0.1"
          value="1"
        />
        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 10px; max-width: 300px; text-align: center;">
          1.0 = normal (25% win on bet, 40% on free)<br>
          2.0 = 2x luck (50% win on bet, 80% on free)<br>
          0.5 = half luck (12% win on bet, 20% on free)
        </div>
        <button class="nexus-btn" onclick="setUserLuck()" style="width: auto; padding: 10px 25px;">Set Luck</button>
        <div id="luck-feedback" style="margin-top: 12px; font-size: 13px; color: var(--accent); min-height: 20px;"></div>
        
        <h2 style="letter-spacing: 2px; margin: 40px 0 20px;">manage user tags</h2>
        <input
          type="text"
          id="tag-username-input"
          class="nexus-input"
          style="max-width: 300px; margin-bottom: 10px;"
          placeholder="Enter username"
          onkeydown="if(event.key==='Enter') setUserTag()"
        />
        <input
          type="text"
          id="tag-name-input"
          class="nexus-input"
          style="max-width: 200px; margin-bottom: 10px;"
          placeholder="Tag name (e.g. OWNER)"
        />
        <input
          type="color"
          id="tag-color-input"
          class="nexus-input"
          style="max-width: 100px; margin-bottom: 10px; padding: 5px; height: 40px;"
          value="#ff0000"
          title="Tag color"
        />
        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 10px; max-width: 300px; text-align: center;">
          'dom' automatically has OWNER tag in red<br>
          Leave tag name empty to remove tag
        </div>
        <button class="nexus-btn" onclick="setUserTag()" style="width: auto; padding: 10px 25px;">Set Tag</button>
        <button class="nexus-btn" onclick="removeUserTag()" style="width: auto; padding: 10px 25px; background: transparent; border-color: var(--alert); color: var(--alert); margin-left: 10px;">Remove Tag</button>
        <div id="tag-feedback" style="margin-top: 12px; font-size: 13px; color: var(--accent); min-height: 20px;"></div>
      </div>

      <div id="profile" class="view">
        <div id="profile-bg-layer" class="profile-view-container">
          <div class="profile-card-ui">
            <button 
            class="nexus-btn logout-btn" 
            onclick="logout()" 
            style="margin-top: -10px; margin-bottom:10px; border-color: var(--alert); color: var(--alert); width: auto; padding: 5px 15px; font-size: 10px;"
          >
            Sign Out
          </button>
            <input
              type="file"
              id="pfp-upload"
              style="display: none"
              accept="image/*"
              onchange="handlePFP(this)"
            />
            <img id="display-pfp" class="avatar-large" src="" />
            <h2
              id="display-username"
              style="
                margin-top: 0;
                letter-spacing: 2px;
                text-transform: lowercase;
                margin-bottom: 5px;
              "
            ></h2>
<div id="display-tag" style="margin-bottom: 10px; display: none;"></div>
<div id="display-bio" style="font-size:11px;opacity:0.7;margin-bottom:10px;text-align:center;max-width:260px;display:none;font-style:italic;"></div>
            <div style="display: flex; align-items: center; gap: 5px">
              <div id="status-dot" class="dot"></div>
              <span
                id="status-text"
                style="font-size: 10px; font-weight: bold; letter-spacing: 1px"
                >OFFLINE</span
              >
            </div>
            <div
              id="pending-requests-section"
              style="
                width: 100%;
                margin-top: 20px;
                border-top: 1px solid var(--border);
                display: none;
              "
            >
              <div
                style="
                  font-size: 10px;
                  color: var(--accent);
                  margin-top: 15px;
                  letter-spacing: 1px;
                "
              >
                PENDING REQUESTS
              </div>
              <div id="requests-list-container"></div>
            </div>
            <div
              id="group-invites-section"
              style="
                width: 100%;
                margin-top: 20px;
                border-top: 1px solid var(--border);
                display: none;
              "
            >
              <div
                style="
                  font-size: 10px;
                  color: var(--accent);
                  margin-top: 15px;
                  letter-spacing: 1px;
                "
              >
                GROUP INVITES
              </div>
              <div id="group-invites-container"></div>
            </div>
            <div
  id="trade-invites-section"
  style="
    width: 100%;
    margin-top: 20px;
    border-top: 1px solid var(--border);
    display: none;
  "
>
  <div
    style="
      font-size: 10px;
      color: var(--accent);
      margin-top: 15px;
      letter-spacing: 1px;
    "
  >
    TRADE INVITES
  </div>
  <div id="trade-invites-container"></div>
</div>
<div id="bio-edit-section" style="display:none;width:100%;margin-top:15px;">
  <textarea
    id="bio-input"
    class="nexus-input"
    style="resize:vertical;min-height:60px;font-size:12px;margin-bottom:6px;"
    placeholder="Write a bio..."
    maxlength="120"
  ></textarea>
  <button class="nexus-btn" onclick="saveBio()" style="width:auto;padding:6px 18px;font-size:11px;">Save Bio</button>
</div>
<div
  id="blocked-section"
  style="width:100%;margin-top:20px;border-top:1px solid var(--border);display:none;"
>
  <div style="font-size:10px;color:var(--alert);margin-top:15px;letter-spacing:1px;">BLOCKED USERS</div>
  <div id="blocked-list-container" style="margin-top:8px;"></div>
</div>

<div id="visitor-log-section" style="display:none;width:100%;margin-top:20px;border-top:1px solid var(--border);padding-top:15px;">
  <div style="font-size:10px;color:var(--accent);letter-spacing:1px;margin-bottom:8px;">RECENT VISITORS</div>
  <div id="visitor-log-list" style="display:flex;flex-direction:column;gap:6px;"></div>
</div>
            <button
              id="pfp-edit-btn"
              class="nexus-btn"
              style="
                width: auto;
                margin-top: 25px;
                padding: 8px 20px;
                font-size: 11px;
                display: none;
              "
              onclick="document.getElementById('pfp-upload').click()"
            >
              Update Avatar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDKOq326tL8Kh1hraa_R0bV0MvYMUZotfk",
        authDomain: "realtime-database-3505d.firebaseapp.com",
        databaseURL:
          "https://realtime-database-3505d-default-rtdb.firebaseio.com",
        projectId: "realtime-database-3505d",
        storageBucket: "realtime-database-3505d.firebasestorage.app",
        messagingSenderId: "917293518076",
        appId: "1:917293518076:web:1cd71d04e6a37af7afdb79",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      window.myName = null;
      let limitedShopItems = {};
      let limitedImageData = null;
      let activeChat = null,
        chatType = "none",
        myBalance = 0,
        myInventory = [],
        myFriends = [];
      let unreadChats = {};
      let friendRequestCount = 0;
      let groupInviteCount = 0;
      let messageNotifTimeout = null;
      let messageListenersAttached = {};
      let messageListenersInitialLoad = {};

      const SHOP_ITEMS = [
        {
          id: "neon_city",
          name: "cyber",
          price: 5,
          url: "neon.png"
        },
        {
          id: "deep_space",
          name: "star",
          price: 15,
          url: "star.png", // URL removed - add back later
        },
        {
          id: "matrix",
          name: "data",
          price: 30,
          url: "data.png"
        },
        {
          id: "felipe_banner",
          name: "deltarune thing",
          price: 0,
          url: "delta.png", // URL removed - add back later
          allowed: ["dom", "felipez tm"],

        },
        {
          id: "gtr_tuffy",
          name: "GTR Tuffy",
          price: 0,
          url: "tuff.gif", // URL removed - add back later
          allowed: ["dom", "stien"],
        },
        {
          id: "hemmy",
          name: "hemmy",
          price: 0,
          url: "hemmy.png", // URL removed - add back later
          allowed: ["dom", "nath"],
        },
        {
          id: "bangs_banner",
          name: "bangs baner",
          price: 0,
          url: "north.png", // URL removed - add back later
          allowed: ["dom", "bang"],
        },
        {
          id: "gtr_drifting",
          name: "gtr drifting",
          price: 0,
          url: "gtr e.gif", // URL removed - add back later
          allowed: ["dom", "nath"],
        },
        {
          id: "green_day",
          name: "green dau",
          price: 0,
          url: "xfcIq0Q.png", // URL removed - add back later
          allowed: ["dom"],
        },
        {
          id: "domer",
          name: "domer",
          price: 100,
          url: "domer.png", // URL removed - add back later
        },
        {
          id: "drake_maye",
          name: "drake maye",
          price: 10000,
          url: "drake.png", // URL removed - add back later
        },
        {
          id: "lebron",
          name: "lebron dunking",
          price: 0,
          url: "", // URL removed - add back later
          allowed: ["dom", "nath"],
        },
        {
  id: "music_wemmbu",
  name: "Song for Wemmbu",
  price: 500,
  url: "",
  type: "music",
  audioUrl: "wemmbu.mp3",
  icon: "üéµ"
},
{
  id: "music_basooka",
  name: "RIP My Granny",
  price: 500,
  url: "",
  type: "music",
  audioUrl: "basooka.mp3",
  icon: "üéµ"
},
{
  id: "music_neon",
  name: "Neon Guts",
  price: 500,
  url: "",
  type: "music",
  audioUrl: "neon guts.mp3",
  icon: "üéµ"
},
      ];

      function init() {
        const storedUsername = localStorage.getItem("nexus_user");
        if (storedUsername) {
          db.ref("banned/" + storedUsername).once("value", (banSnap) => {
            if (banSnap.val() === true) {
              showBannedScreen();
              return;
            }
            db.ref("users/" + storedUsername).once("value", (snap) => {
              if (snap.exists()) {
                window.myName = storedUsername;
                loadUserLuck(); // Load user's slot luck
                showHub();
              } else {
                localStorage.removeItem("nexus_user");
                window.myName = null;
                runWelcome();
              }
              if (window.myName === "j") {
                document.getElementById("switch-dom-tab").style.display = "block";
              }
              if (window.myName === "dom") {
                document.getElementById("nav-admin").style.display = "block";
              }
            });
          });
        } else {
          runWelcome();
        }
      }

      function showBannedScreen() {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;background:#000;color:#ff4444;font-size:48px;font-weight:bold;text-align:center;font-family:\'Segoe UI\',sans-serif;">get banned lmao</div>';
      }

      function runWelcome() {
        const terminalText = document.getElementById("terminal-text");
        const loadingMessages = document.getElementById("loading-messages");
        const usernameInputArea = document.getElementById("username-input-area");
        const terminalUsernameInput = document.getElementById("terminal-username-input");
        const terminal = document.getElementById("terminal-container");
        const terminalOutput = document.getElementById("terminal-output");
        
        // Clear terminal and start
        terminalText.innerHTML = "Microsoft Windows [Version 10.0.19045.2364]<br>(c) Microsoft Corporation. All rights reserved.<br><br>";
        
        // Welcome message typing effect
        const welcomeText = "C:\\Users\\Nexus> nexus.exe --welcome";
        let i = 0;
        
        const typeInterval = setInterval(() => {
          if (i < welcomeText.length) {
            terminalText.innerHTML += welcomeText[i];
            i++;
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
          } else {
            clearInterval(typeInterval);
            
            // Add response
            setTimeout(() => {
              terminalText.innerHTML += "<br>welcome to nexus<br>ready to get started<br><br>";
              terminalOutput.scrollTop = terminalOutput.scrollHeight;
              
              // Show loading messages rapidly
              setTimeout(() => {
                loadingMessages.style.display = "block";
                const messages = [
                  "loading shop...",
                  "updating profile...",
                  "building usernames...", 
                  "installing water...",
                  "initializing chat...",
                  "configuring inventory...",
                  "syncing leaderboards...",
                  "enabling notifications...",
                  "optimizing performance...",
                  "finalizing setup..."
                ];
                
                let msgIndex = 0;
                const msgInterval = setInterval(() => {
                  if (msgIndex < messages.length) {
                    loadingMessages.innerHTML += messages[msgIndex] + "<br>";
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    msgIndex++;
                  } else {
                    clearInterval(msgInterval);
                    
                    // Show completion message
                    setTimeout(() => {
                      loadingMessages.innerHTML += "<br>System initialized successfully.<br><br>";
                      terminalOutput.scrollTop = terminalOutput.scrollHeight;
                      
                      // Show username input AFTER loading completes
                      setTimeout(() => {
                        usernameInputArea.style.display = "block";
                        terminalUsernameInput.focus();
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        
                        // Handle username input
                        terminalUsernameInput.addEventListener("keypress", function(e) {
                          if (e.key === "Enter") {
                            const username = this.value.trim();
                            if (username) {
                              // Show the entered command at the bottom
                              terminalText.innerHTML += `<br>C:\\Users\\Nexus>${username}<br>`;
                              terminalOutput.scrollTop = terminalOutput.scrollHeight;
                              
                              // Hide the input area
                              usernameInputArea.style.display = "none";
                              
                              // Process username registration/login
                              processUsername(username);
                            }
                          }
                        });
                      }, 500);
                    }, 500);
                  }
                }, 100); // Fast loading messages
              }, 800);
            }, 300);
          }
        }, 50);
      }

      function processUsername(username) {
        const terminalText = document.getElementById("terminal-text");
        const terminalOutput = document.getElementById("terminal-output");
        
        // Show processing messages
        terminalText.innerHTML += `Creating user: ${username}...<br>User created successfully.<br><br>`;
        terminalOutput.scrollTop = terminalOutput.scrollHeight;
        
        // Store username and register
        setTimeout(() => {
          document.getElementById("username-input").value = username;
          register();
        }, 500);
      }

      function register() {
        const name = document.getElementById("username-input").value.trim().toLowerCase();
        const terminalText = document.getElementById("terminal-text");
        const terminalOutput = document.getElementById("terminal-output");
        
        if (!name) {
          terminalText.innerHTML += `<span style="color: #ff4444;">Error: Please enter a username</span><br>`;
          terminalOutput.scrollTop = terminalOutput.scrollHeight;
          return;
        }
        
        // --- NEW PIN LOGIC FOR DOM ---
        if (name === "dom") {
          const pin = prompt("Enter Security PIN for 'dom':");
          if (pin !== "1699") {
            terminalText.innerHTML += `<span style="color: #ff4444;">Invalid PIN. Access Denied.</span><br>`;
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
            return;
          }
        }
        // -----------------------------
        
        db.ref("users/" + name).once("value", (snap) => {
          if (snap.exists() && name !== "dom") {
            // Account exists - check for PIN
            const userData = snap.val();
            
            if (userData.pin) {
              // User has a PIN set, require it
              terminalText.innerHTML += `<span style="color: var(--accent);">Account protected by PIN...</span><br>`;
              terminalOutput.scrollTop = terminalOutput.scrollHeight;
              
              setTimeout(() => {
                const enteredPin = prompt(`Enter PIN for '${name}':`);
                if (enteredPin !== userData.pin) {
                  terminalText.innerHTML += `<span style="color: #ff4444;">Invalid PIN. Access Denied.</span><br>`;
                  terminalOutput.scrollTop = terminalOutput.scrollHeight;
                  return;
                }
                // PIN correct, proceed with login
                completeLogin(name, snap.exists());
              }, 500);
            } else {
              // No PIN set, proceed with login
              completeLogin(name, snap.exists());
            }
          } else {
            // New account - create without PIN
            completeLogin(name, snap.exists());
          }
        });
      }
      
      function completeLogin(name, accountExists) {
        const terminalText = document.getElementById("terminal-text");
        const terminalOutput = document.getElementById("terminal-output");
        
        if (accountExists) {
          terminalText.innerHTML += `<span style="color: #00ff88;">Account found. Logging in...</span><br>`;
        } else {
          terminalText.innerHTML += `<span style="color: #00ff88;">Creating new account...</span><br>`;
        }
        terminalOutput.scrollTop = terminalOutput.scrollHeight;
        
        localStorage.setItem("nexus_user", name);
        window.myName = name;
        
        const updates = {
          last_login: Date.now(),
          status: "online",
        };
        
        // Set initial balance if new user
        if (!accountExists) {
          updates.balance = 0;
        }
        
        db.ref("users/" + name).update(updates).then(() => {
          if (!accountExists) {
            terminalText.innerHTML += `<span style="color: #00ff88;">Account created successfully! Welcome to Nexus, ${name}!</span><br>`;
            terminalText.innerHTML += `<span style="color: var(--accent);">‚ö†Ô∏è Tip: Go to Security to set up a PIN for your account!</span><br>`;
          } else {
            terminalText.innerHTML += `<span style="color: #00ff88;">Welcome back, ${name}!</span><br>`;
          }
          terminalOutput.scrollTop = terminalOutput.scrollHeight;
          setTimeout(() => location.reload(), 1500);
        });
      }

      function showHub() {
        document.getElementById("welcome-screen").style.display = "none";
        document.getElementById("hub").style.display = "flex";
        setTimeout(
          () => (document.getElementById("hub").style.opacity = "1"),
          50
        );

        db.ref("users/" + window.myName + "/status").set("online");
        db.ref("users/" + window.myName + "/status")
          .onDisconnect()
          .set("offline");

        setInterval(() => {
          db.ref("users/" + window.myName + "/balance").transaction(
            (c) => (c || 0) + 1
          );
          const pop = document.getElementById("money-pop");
          pop.style.display = "block";
          setTimeout(() => (pop.style.display = "none"), 3000);
          
          // Update time played (60 seconds = 1 minute)
          db.ref("users/" + window.myName + "/timePlayed").transaction(
            (t) => (t || 0) + 60
          );
        }, 60000);

        db.ref("users/" + window.myName + "/balance").on("value", (snap) => {
          if (window.myName === "felipez" || window.myName === "j") {
            myBalance = 999999;
            document.getElementById("shop-balance").innerText = "‚àû";
          } else {
            myBalance = snap.val() || 0;
            document.getElementById("shop-balance").innerText = myBalance;
          }
          renderShop();
        });

        db.ref("users/" + window.myName + "/inventory").on("value", (snap) => {
          myInventory = snap.val() || [];
          renderShop();
          renderInventory();
        });

        listenFriends();
        listenGroups();
        listenRequests();
        listenGroupInvites();
listenTradeInvites();
        listenGlobalMessage();
        listenLimitedShopItems();
        setupMessageListeners();
        listenNotifications();
        listenPopups();
        checkPinStatus(); // Check PIN status and update security badge
      }

      // Check PIN status and show/hide security badge
      function checkPinStatus() {
        if (!window.myName) return;
        db.ref("users/" + window.myName + "/pin").on("value", (snap) => {
          const badge = document.getElementById("security-badge");
          if (badge) {
            // Show badge if no PIN is set
            badge.style.display = snap.val() ? "none" : "block";
          }
          // Also update security page if visible
          updateSecurityPage(snap.val());
        });
      }

      // Update security page UI based on PIN status
      function updateSecurityPage(pinValue) {
        const statusDiv = document.getElementById("pin-status");
        const setupSection = document.getElementById("pin-setup-section");
        const changeSection = document.getElementById("pin-change-section");
        
        if (!statusDiv) return; // Security page not created yet
        
        if (pinValue) {
          statusDiv.innerHTML = `<span style="color: var(--online);">üîí PIN is set</span>`;
          statusDiv.innerHTML += `<div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Your account is protected</div>`;
          if (setupSection) setupSection.style.display = "none";
          if (changeSection) changeSection.style.display = "block";
        } else {
          statusDiv.innerHTML = `<span style="color: var(--alert);">‚ö†Ô∏è No PIN set</span>`;
          statusDiv.innerHTML += `<div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Your account is not protected</div>`;
          if (setupSection) setupSection.style.display = "block";
          if (changeSection) changeSection.style.display = "none";
        }
      }

      // Set new PIN
      function setPin() {
        const newPin = document.getElementById("new-pin-input").value;
        const confirmPin = document.getElementById("confirm-pin-input").value;
        const feedback = document.getElementById("pin-feedback");
        
        feedback.innerText = "";
        
        // Validate PIN
        if (!newPin || newPin.length !== 4) {
          feedback.innerText = "PIN must be 4 digits";
          feedback.style.color = "var(--alert)";
          return;
        }
        if (!/^\d{4}$/.test(newPin)) {
          feedback.innerText = "PIN must contain only numbers";
          feedback.style.color = "var(--alert)";
          return;
        }
        if (newPin !== confirmPin) {
          feedback.innerText = "PINs do not match";
          feedback.style.color = "var(--alert)";
          return;
        }
        
        // Save PIN to Firebase
        db.ref("users/" + window.myName + "/pin").set(newPin, (err) => {
          if (err) {
            feedback.innerText = "Failed to set PIN";
            feedback.style.color = "var(--alert)";
          } else {
            feedback.innerText = "PIN set successfully!";
            feedback.style.color = "var(--online)";
            document.getElementById("new-pin-input").value = "";
            document.getElementById("confirm-pin-input").value = "";
          }
        });
      }

      // Change existing PIN
      function changePin() {
        const currentPin = document.getElementById("current-pin-input").value;
        const newPin = document.getElementById("new-change-pin-input").value;
        const feedback = document.getElementById("pin-feedback");
        
        feedback.innerText = "";
        
        // Validate new PIN
        if (!newPin || newPin.length !== 4) {
          feedback.innerText = "New PIN must be 4 digits";
          feedback.style.color = "var(--alert)";
          return;
        }
        if (!/^\d{4}$/.test(newPin)) {
          feedback.innerText = "PIN must contain only numbers";
          feedback.style.color = "var(--alert)";
          return;
        }
        
        // Verify current PIN
        db.ref("users/" + window.myName + "/pin").once("value", (snap) => {
          const storedPin = snap.val();
          if (currentPin !== storedPin) {
            feedback.innerText = "Current PIN is incorrect";
            feedback.style.color = "var(--alert)";
            return;
          }
          
          // Save new PIN
          db.ref("users/" + window.myName + "/pin").set(newPin, (err) => {
            if (err) {
              feedback.innerText = "Failed to change PIN";
              feedback.style.color = "var(--alert)";
            } else {
              feedback.innerText = "PIN changed successfully!";
              feedback.style.color = "var(--online)";
              document.getElementById("current-pin-input").value = "";
              document.getElementById("new-change-pin-input").value = "";
            }
          });
        });
      }

      // Remove PIN
      function removePin() {
        const feedback = document.getElementById("pin-feedback");
        
        if (!confirm("Are you sure you want to remove your PIN? This will make your account less secure.")) {
          return;
        }
        
        db.ref("users/" + window.myName + "/pin").remove((err) => {
          if (err) {
            feedback.innerText = "Failed to remove PIN";
            feedback.style.color = "var(--alert)";
          } else {
            feedback.innerText = "PIN removed";
            feedback.style.color = "var(--online)";
            document.getElementById("current-pin-input").value = "";
            document.getElementById("new-change-pin-input").value = "";
          }
        });
      }

      function getMutedChats() {
        try {
          const s = localStorage.getItem("nexus_muted_" + window.myName);
          return s ? JSON.parse(s) : {};
        } catch (e) { return {}; }
      }
      function saveMutedChats(m) {
        localStorage.setItem("nexus_muted_" + window.myName, JSON.stringify(m));
      }
      function toggleMuteNotifications() {
        const cid = getCurrentChatId();
        if (!cid) return;
        const m = getMutedChats();
        m[cid] = !m[cid];
        saveMutedChats(m);
        updateMuteButton();
      }
      function getCurrentChatId() {
        if (chatType === "global") return "GLOBAL_CHAT";
        if (chatType === "group") return activeChat;
        if (chatType === "private" && activeChat) return [window.myName, activeChat].sort().join("_");
        return null;
      }
      function updateMuteButton() {
        const btn = document.getElementById("mute-notif-btn");
        if (!btn) return;
        const cid = getCurrentChatId();
        if (!cid || chatType === "none") { btn.style.display = "none"; return; }
        btn.style.display = "block";
        const m = getMutedChats();
        const muted = m[cid];
        const labels = { global: "chatroom", group: "group", private: "contact" };
        btn.innerText = muted ? "unmute notifications for this " + (labels[chatType] || "chat") : "mute notifications for this " + (labels[chatType] || "chat");
      }
      function setupMessageListeners() {
        const attach = (chatId) => {
          if (messageListenersAttached[chatId]) return;
          messageListenersAttached[chatId] = true;
          messageListenersInitialLoad[chatId] = true;
          db.ref("messages/" + chatId).limitToLast(1).on("child_added", (snap) => {
            const d = snap.val();
            if (!d || d.sender === window.myName) return;
            if (messageListenersInitialLoad[chatId]) {
              messageListenersInitialLoad[chatId] = false;
              return;
            }
            if (getCurrentChatId() === chatId) return;
            if (getMutedChats()[chatId]) return;
            unreadChats[chatId] = true;
            updateUnreadUI();
            const notif = document.getElementById("message-notification");
            if (notif) { notif.classList.add("show"); }
            clearTimeout(messageNotifTimeout);
            messageNotifTimeout = setTimeout(() => { if (notif) notif.classList.remove("show"); }, 5000);
          });
        };
        attach("GLOBAL_CHAT");
        const refresh = () => {
          db.ref("users/" + window.myName + "/friends").once("value", (fSnap) => {
            if (fSnap.exists()) fSnap.forEach((f) => attach([window.myName, f.key].sort().join("_")));
          });
          db.ref("groups").once("value", (gSnap) => {
            gSnap.forEach((g) => {
              const data = g.val();
              if (data && data.members && data.members[window.myName]) attach(g.key);
            });
          });
        };
        refresh();
        db.ref("users/" + window.myName + "/friends").on("value", () => { setTimeout(refresh, 200); });
        db.ref("groups").on("value", () => setTimeout(refresh, 200));
      }
      function updateUnreadUI() {
        const items = document.querySelectorAll(".contact-item[data-chat-id]");
        items.forEach((el) => {
          const cid = el.dataset.chatId;
          el.classList.toggle("unread", !!unreadChats[cid]);
        });
        const chatBadge = document.getElementById("chat-badge");
        const unreadCount = Object.keys(unreadChats).filter((k) => unreadChats[k]).length;
        if (chatBadge) chatBadge.style.display = unreadCount > 0 ? "block" : "none";
      }

      function listenGroupInvites() {
        db.ref("groupInvites/" + window.myName).on("value", (snap) => {
          const container = document.getElementById("group-invites-container");
          container.innerHTML = "";
          groupInviteCount = 0;
          snap.forEach((inv) => {
            const data = inv.val();
            if (!data) return;
            groupInviteCount++;
            const div = document.createElement("div");
            div.className = "request-item";
            div.innerHTML = `
              <span>${data.from} invited you to "${data.groupName}"</span>
              <button class="nexus-btn" style="width:auto; padding:2px 10px;" onclick="acceptGroupInvite('${inv.key}')">Accept</button>
            `;
            container.appendChild(div);
          });
          updateProfileBadge();
        });
      }

      function acceptGroupInvite(groupId) {
        db.ref("groups/" + groupId).once("value", (snap) => {
          const data = snap.val();
          if (!data) return;
          db.ref("groups/" + groupId + "/members/" + window.myName).set(true);
          db.ref("groupInvites/" + window.myName + "/" + groupId).remove();
          db.ref("messages/" + groupId).push({
            sender: "_system",
            text: window.myName + " has joined " + data.name,
            timestamp: Date.now(),
            seen: { [window.myName]: true },
          });
          tab("chat");
          setTimeout(() => {
            const el = document.querySelector("#group-list .contact-item[data-group-id=\"" + groupId + "\"]");
            openChat(groupId, el || null, "group");
          }, 200);
        });
      }

      function handleLimitedImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          limitedImageData = e.target.result;
          document.getElementById("limited-preview-img").src = limitedImageData;
          document.getElementById("limited-image-preview").style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      function submitLimitedSkin() {
        if (window.myName !== "dom") return;
        const name = document.getElementById("limited-name-input").value.trim();
        const duration = parseInt(document.getElementById("limited-duration-input").value, 10);
        const unit = document.getElementById("limited-duration-unit").value;
        const price = parseInt(document.getElementById("limited-price-input").value, 10) || 0;
        const feedback = document.getElementById("limited-feedback");
        if (!name) { feedback.innerText = "Enter a name"; return; }
        if (!limitedImageData) { feedback.innerText = "Choose an image"; return; }
        if (!duration || duration < 1) { feedback.innerText = "Enter valid duration"; return; }
        const durationMs = unit === "hours" ? duration * 60 * 60 * 1000 : duration * 60 * 1000;
        const id = "limited_" + Date.now();
        const item = { id, name, url: limitedImageData, price, durationMs, createdAt: Date.now() };
        db.ref("limitedShopItems/" + id).set(item).then(() => {
          feedback.innerText = "Added to shop!";
          document.getElementById("limited-name-input").value = "";
          document.getElementById("limited-duration-input").value = "";
          document.getElementById("limited-price-input").value = "0";
          limitedImageData = null;
          document.getElementById("limited-image-preview").style.display = "none";
          document.getElementById("limited-image-input").value = "";
        }).catch(() => { feedback.innerText = "Failed."; });
      }

      function listenLimitedShopItems() {
        db.ref("limitedShopItems").on("value", (snap) => {
          limitedShopItems = snap.val() || {};
          renderShop();
          renderInventory();
        });
        if (!window._limitedShopInterval) {
          window._limitedShopInterval = setInterval(() => {
            if (Object.keys(limitedShopItems).length > 0) renderShop();
          }, 60000);
        }
      }

      function formatRemainingTime(ms) {
        if (ms <= 0) return "EXPIRED";
        const mins = Math.floor(ms / 60000);
        const hours = Math.floor(ms / 3600000);
        if (hours >= 1) return hours + " HOUR" + (hours > 1 ? "S" : "");
        return mins + " MINUTE" + (mins > 1 ? "S" : "");
      }

      function sendGlobalMessage() {
        if (window.myName !== "dom") return;
        const msg = document.getElementById("global-message-input").value.trim();
        if (!msg) return;
        db.ref("globalMessage").set({
          text: msg,
          timestamp: Date.now()
        });
        document.getElementById("global-message-input").value = "";
      }

      function listenGlobalMessage() {
        db.ref("globalMessage").on("value", (snap) => {
          const d = snap.val();
          if (d && d.text && Date.now() - (d.timestamp || 0) < 15000) {
            showGlobalNotification(d.text);
          }
        });
      }

      let globalNotifTimeout;
let utTypingInterval = null;

function showGlobalNotification(text) {
  const el = document.getElementById("global-notification");
  const textEl = document.getElementById("ut-notif-text");
  if (!el || !textEl) return;

  // Clear any previous typing
  if (utTypingInterval) clearInterval(utTypingInterval);
  textEl.innerHTML = '<span class="ut-cursor"></span>';

  el.classList.remove("hide");
  el.classList.add("show");

  // Typing animation
  let i = 0;
  utTypingInterval = setInterval(() => {
    if (i < text.length) {
      textEl.innerHTML = text.substring(0, i + 1) + '<span class="ut-cursor"></span>';
      i++;
    } else {
      clearInterval(utTypingInterval);
      utTypingInterval = null;
    }
  }, 72);

  clearTimeout(globalNotifTimeout);
  // Keep open long enough to read the whole message
  const displayTime = Math.max(5000, text.length * 72 + 2500);
  globalNotifTimeout = setTimeout(() => {
    el.classList.remove("show");
    el.classList.add("hide");
  }, displayTime);
}

      // PERSONAL NOTIFICATIONS (for things like credits)
      function listenNotifications() {
        try {
          const ref = db.ref("notifications/" + window.myName).limitToLast(1);
          ref.once("value", (snap) => {
            let lastTs = 0;
            snap.forEach((s) => { const v = s.val(); if (v && v.timestamp) lastTs = v.timestamp; });
            db.ref("notifications/" + window.myName).on("child_added", (childSnap) => {
              const d = childSnap.val();
              if (!d || !d.text) return;
              const ts = d.timestamp || 0;
              if (ts <= lastTs) return;
              showPersonalNotification(d.text);
            });
          });
        } catch (e) {
          // ignore
        }
      }

      function showPersonalNotification(text) {
  // Temporarily change speaker label for personal notifs
  const speakerEl = document.querySelector("#global-notification .ut-speaker");
  if (speakerEl) speakerEl.textContent = "* system :";
  showGlobalNotification(text);
  // Restore after
  setTimeout(() => {
    const s = document.querySelector("#global-notification .ut-speaker");
    if (s) s.textContent = "* dom :";
  }, 100);
}

      function giveCredits() {
        if (window.myName !== "dom") return;
        const user = (document.getElementById("credit-username-input").value || "").trim().toLowerCase();
        const amountRaw = document.getElementById("credit-amount-input").value;
        const fb = document.getElementById("credit-feedback");
        fb.innerText = "";
        const amount = parseInt(amountRaw, 10);
        if (!user) { fb.innerText = "Enter a username."; return; }
        if (!amount || amount <= 0) { fb.innerText = "Enter a valid amount."; return; }
        // special-case: give to everyone online
        if (user === "everyone") {
          db.ref("users").once("value", (snap) => {
            const online = [];
            snap.forEach((s) => {
              const k = s.key;
              const d = s.val() || {};
              if (d.status === "online") online.push(k);
            });
            if (online.length === 0) { fb.innerText = "No online users to credit."; return; }
            online.forEach((u) => {
              db.ref("users/" + u + "/balance").transaction((c) => (c || 0) + amount);
              db.ref("notifications/" + u).push({
                text: `dom has given you ${amount} credits`,
                from: "dom",
                timestamp: Date.now(),
              });
            });
            fb.innerText = `Gave ${amount} credits to ${online.length} online users.`;
            document.getElementById("credit-username-input").value = "";
            document.getElementById("credit-amount-input").value = "";
          });
          return;
        }

        db.ref("users/" + user).once("value", (snap) => {
          if (!snap.exists()) {
            fb.innerText = "User not found.";
            return;
          }

          db.ref("users/" + user + "/balance").transaction((c) => (c || 0) + amount, (err, committed, ss) => {
            if (err || !committed) {
              fb.innerText = "Failed to add credits.";
              return;
            }
            // push a personal notification
            db.ref("notifications/" + user).push({
              text: `dom has given you ${amount} credits`,
              from: "dom",
              timestamp: Date.now()
            });
            fb.innerText = `Gave ${amount} credits to ${user}.`;
            document.getElementById("credit-username-input").value = "";
            document.getElementById("credit-amount-input").value = "";
          });
        });
      }

      // ADMIN: Set user's slot machine luck multiplier
      function setUserLuck() {
        if (window.myName !== "dom") return;
        const user = (document.getElementById("luck-username-input").value || "").trim().toLowerCase();
        const luckValue = parseFloat(document.getElementById("luck-value-input").value);
        const fb = document.getElementById("luck-feedback");
        fb.innerText = "";
        
        if (!user) { fb.innerText = "Enter a username."; return; }
        if (isNaN(luckValue) || luckValue < 0.1 || luckValue > 10) { 
          fb.innerText = "Enter a luck value between 0.1 and 10."; 
          return; 
        }
        
        db.ref("users/" + user).once("value", (snap) => {
          if (!snap.exists()) {
            fb.innerText = "User not found.";
            return;
          }
          
          db.ref("users/" + user + "/luck").set(luckValue, (err) => {
            if (err) {
              fb.innerText = "Failed to set luck.";
              return;
            }
            
            // Push notification to user
            db.ref("notifications/" + user).push({
              text: `Your slot luck has been set to ${luckValue}x!`,
              from: "dom",
              timestamp: Date.now()
            });
            
            fb.innerText = `Set ${user}'s luck to ${luckValue}x.`;
            fb.style.color = "var(--online)";
            document.getElementById("luck-username-input").value = "";
            document.getElementById("luck-value-input").value = "1";
          });
        });
      }

      // ADMIN: Set user tag
      function setUserTag() {
        if (window.myName !== "dom") return;
        const user = (document.getElementById("tag-username-input").value || "").trim().toLowerCase();
        const tagName = (document.getElementById("tag-name-input").value || "").trim().toUpperCase();
        const tagColor = document.getElementById("tag-color-input").value;
        const fb = document.getElementById("tag-feedback");
        fb.innerText = "";
        
        if (!user) { fb.innerText = "Enter a username."; fb.style.color = "var(--alert)"; return; }
        if (!tagName) { fb.innerText = "Enter a tag name."; fb.style.color = "var(--alert)"; return; }
        
        db.ref("users/" + user).once("value", (snap) => {
          if (!snap.exists()) {
            fb.innerText = "User not found.";
            fb.style.color = "var(--alert)";
            return;
          }
          
          const tagData = {
            name: tagName,
            color: tagColor
          };
          
          db.ref("users/" + user + "/tag").set(tagData, (err) => {
            if (err) {
              fb.innerText = "Failed to set tag.";
              fb.style.color = "var(--alert)";
              return;
            }
            
            // Push notification to user
            db.ref("notifications/" + user).push({
              text: `You have been given the ${tagName} tag!`,
              from: "dom",
              timestamp: Date.now()
            });
            
            fb.innerText = `Set ${user}'s tag to ${tagName}.`;
            fb.style.color = "var(--online)";
            document.getElementById("tag-username-input").value = "";
            document.getElementById("tag-name-input").value = "";
          });
        });
      }

      // ADMIN: Remove user tag
      function removeUserTag() {
        if (window.myName !== "dom") return;
        const user = (document.getElementById("tag-username-input").value || "").trim().toLowerCase();
        const fb = document.getElementById("tag-feedback");
        fb.innerText = "";
        
        if (!user) { fb.innerText = "Enter a username."; fb.style.color = "var(--alert)"; return; }
        
        db.ref("users/" + user + "/tag").remove((err) => {
          if (err) {
            fb.innerText = "Failed to remove tag.";
            fb.style.color = "var(--alert)";
            return;
          }
          
          fb.innerText = `Removed ${user}'s tag.`;
          fb.style.color = "var(--online)";
          document.getElementById("tag-username-input").value = "";
          document.getElementById("tag-name-input").value = "";
        });
      }

      // Get user tag (dom always has OWNER in red)
      function getUserTag(username) {
        if (username === "dom") {
          return { name: "OWNER", color: "#ff0000" };
        }
        return null;
      }

      // ADMIN: trigger image popup for a user or everyone online
      function triggerImagePopup() {
        if (window.myName !== "dom") return;
        const target = (document.getElementById("popup-target-input").value || "").trim().toLowerCase();
        const duration = parseInt(document.getElementById("popup-duration-input").value || "5", 10) || 5;
        const url = (document.getElementById("popup-url-input").value || "").trim();
        const fb = document.getElementById("popup-feedback");
        fb.innerText = "";
        if (!target) { fb.innerText = "Enter a username or 'everyone'."; return; }
        if (!url) { fb.innerText = "Enter an image URL."; return; }

        if (target === "everyone") {
          db.ref("users").once("value", (snap) => {
            const online = [];
            snap.forEach((s) => {
              const k = s.key;
              const d = s.val() || {};
              if (d.status === "online") online.push(k);
            });
            if (online.length === 0) { fb.innerText = "No online users to show image."; return; }
            online.forEach((u) => {
              db.ref("popups/" + u).push({ url, duration, from: "dom", timestamp: Date.now() });
            });
            fb.innerText = `Shown image to ${online.length} online users.`;
          });
          return;
        }

        db.ref("users/" + target).once("value", (snap) => {
          if (!snap.exists()) { fb.innerText = "User not found."; return; }
          db.ref("popups/" + target).push({ url, duration, from: "dom", timestamp: Date.now() });
          fb.innerText = `Shown image to ${target}.`;
        });
      }

      // CLIENT: listen for popups for this user and show image when received (ignore old ones at load)
      function listenPopups() {
        try {
          const ref = db.ref("popups/" + window.myName).limitToLast(1);
          ref.once("value", (snap) => {
            let lastTs = 0;
            snap.forEach((s) => { const v = s.val(); if (v && v.timestamp) lastTs = v.timestamp; });
            db.ref("popups/" + window.myName).on("child_added", (childSnap) => {
              const d = childSnap.val();
              if (!d || !d.url) return;
              const ts = d.timestamp || 0;
              if (ts <= lastTs) return;
              showImagePopup(d.url, d.duration || 5);
            });
          });
        } catch (e) {
          // ignore
        }
      }

      let imagePopupTimeout = null;
      function showImagePopup(url, duration) {
        const wrapper = document.getElementById("image-popup");
        const img = document.getElementById("image-popup-img");
        const flash = document.getElementById("image-popup-flash");
        if (!wrapper || !img || !flash) return;
        
        // Trigger flash animation
        flash.classList.add("flash-animate");
        setTimeout(() => {
          flash.classList.remove("flash-animate");
        }, 700);
        
        img.src = url;
        wrapper.style.display = "block";
        clearTimeout(imagePopupTimeout);
        imagePopupTimeout = setTimeout(() => {
          hideImagePopup();
        }, (duration || 5) * 1000);
      }

      function hideImagePopup() {
        const wrapper = document.getElementById("image-popup");
        const img = document.getElementById("image-popup-img");
        if (!wrapper || !img) return;
        wrapper.style.display = "none";
        img.src = "";
        clearTimeout(imagePopupTimeout);
      }

      function listenFriends() {
        db.ref("users/" + window.myName + "/friends").on("value", (snap) => {
          const list = document.getElementById("friend-list");
          list.innerHTML = "";
          myFriends = [];
          snap.forEach((f) => {
            const fName = f.key;
            myFriends.push(fName);
            const div = document.createElement("div");
            div.className = "contact-item";
            div.dataset.chatId = [window.myName, fName].sort().join("_");
            div.innerHTML = `
            <img id="sidebar-pfp-${fName}" class="avatar-circle" src="https://via.placeholder.com/34">
            <span style="flex:1">${fName}</span>
            <button onclick="unfriend('${fName}')" style="
              background:none;
              border:none;
              color:var(--alert);
              font-size:12px;
              cursor:pointer;
            ">‚úñ</button>
          `;

            div.onclick = () => openChat(fName, div, "private");
            list.appendChild(div);
            db.ref("users/" + fName + "/pfp").on("value", (s) => {
              const img = document.getElementById(`sidebar-pfp-${fName}`);
              if (img) img.src = s.val() || "https://via.placeholder.com/34";
            });
          });
        });
      }

      function addFriend() {
        const f = prompt("Enter designation:").toLowerCase();
        if (f && f !== window.myName) {
          db.ref("requests/" + f + "/" + window.myName).set(true);
          alert("Request sent.");
        }
      }

      function updateProfileBadge() {
        const badge = document.getElementById("notif-badge");
        const total = friendRequestCount + groupInviteCount;
        badge.style.display = total > 0 ? "block" : "none";
      }

      function listenRequests() {
        db.ref("requests/" + window.myName).on("value", (snap) => {
          const container = document.getElementById("requests-list-container");
          container.innerHTML = "";
          friendRequestCount = 0;
          snap.forEach((r) => {
            friendRequestCount++;
            const div = document.createElement("div");
            div.className = "request-item";
            div.innerHTML = `<span>${r.key}</span> <button class="nexus-btn" style="width:auto; padding:2px 10px;" onclick="acceptFriend('${r.key}')">Accept</button>`;
            container.appendChild(div);
          });
          updateProfileBadge();
        });
      }

      function acceptFriend(name) {
        db.ref("users/" + window.myName + "/friends/" + name).set(true);
        db.ref("users/" + name + "/friends/" + window.myName).set(true);
        db.ref("requests/" + window.myName + "/" + name).remove();
      }

      function openChat(id, el, type) {
        activeChat = id;
        chatType = type;
        const hPfp = document.getElementById("header-pfp");
        const groupBtn = document.getElementById("make-group-btn");
        const manageBtn = document.getElementById("manage-group-btn");

        hPfp.style.display = "block";
        groupBtn.style.display = type === "private" ? "block" : "none";
manageBtn.style.display = "none";
const membersBtn = document.getElementById("members-btn");
if (membersBtn) membersBtn.style.display = "block";

        if (type === "global") {
          hPfp.style.display = "none";
          document.getElementById("active-chat-user").innerText =
            "Public Terminal";
        } else if (type === "private") {
          document.getElementById("active-chat-user").innerText =
            "Direct Link: " + id;
          db.ref("users/" + id + "/pfp").on("value", (snap) => {
            hPfp.src = snap.val() || "https://via.placeholder.com/34";
          });
        } else if (type === "group") {
          db.ref("groups/" + id).on("value", (snap) => {
            const data = snap.val();
            if (!data) return;
            document.getElementById("active-chat-user").innerText =
              "GC: " + data.name;
            hPfp.src = "https://via.placeholder.com/34?text=GC";
            if (data.owner === window.myName) manageBtn.style.display = "block";
          });
        }

        document
          .querySelectorAll(".contact-item")
          .forEach((i) => i.classList.remove("selected"));
        if (el) el.classList.add("selected");

        const chatId =
          type === "global"
            ? "GLOBAL_CHAT"
            : type === "group"
            ? id
            : [window.myName, id].sort().join("_");
        db.ref("messages/" + chatId).off();
        const msgRef = db.ref("messages/" + chatId).limitToLast(50);

        const boxes = [
          document.getElementById("chat-msgs"),
          document.getElementById("water-msgs"),
        ];

        boxes.forEach((b) => (b.innerHTML = ""));

        msgRef.off();
        const chatIdFinal =
          type === "global"
            ? "GLOBAL_CHAT"
            : type === "group"
            ? id
            : [window.myName, id].sort().join("_");

        markMessagesSeen(chatIdFinal);

        delete unreadChats[chatIdFinal];
        updateUnreadUI();
        updateMuteButton();

        msgRef.on("child_added", (snap) => {
          const d = snap.val();
          boxes.forEach((box) => {
            renderMessage(box, snap.key, d);
            box.scrollTop = box.scrollHeight;
          });
        });
      }

      function sendMsg(source) {
        const inputId = source === "water" ? "water-chat-input" : "chat-input";
        const inp = document.getElementById(inputId);
        if (!activeChat || !inp.value.trim()) return;

        const text = inp.value;
        
        // Character limit check
        const MAX_LENGTH = 212;
        if (text.length > MAX_LENGTH) {
          alert(`Message too long! Maximum ${MAX_LENGTH} characters allowed.`);
          return;
        }
        
        inp.value = "";

        const chatId =
          chatType === "global"
            ? "GLOBAL_CHAT"
            : chatType === "group"
            ? activeChat
            : [window.myName, activeChat].sort().join("_");
        db.ref("messages/" + chatId).push({
          sender: window.myName,
          text,
          timestamp: Date.now(),
          seen: { [window.myName]: true },
        });
      }

      function groupInviteAction() {
        if (chatType !== "group" || !activeChat) return;
        db.ref("groups/" + activeChat).once("value", (snap) => {
          const data = snap.val();
          if (!data) return;
          const username = prompt("Who do you want to invite?").trim().toLowerCase();
          if (!username) return;
          if (username === window.myName) {
            alert("You can't invite yourself.");
            return;
          }
          if (data.members && data.members[username]) {
            alert("That user is already in the group.");
            return;
          }
          db.ref("users/" + username).once("value", (uSnap) => {
            if (!uSnap.exists()) {
              alert("User not found.");
              return;
            }
            db.ref("groupInvites/" + username + "/" + activeChat).set({
              from: window.myName,
              groupName: data.name,
            });
            alert("Invite sent to " + username + ".");
          });
        });
      }

      function manageGroup() {
        if (chatType !== "group" || !activeChat) return;
        db.ref("groups/" + activeChat).once("value", (snap) => {
          const data = snap.val();
          if (!data || data.owner !== window.myName) return;
          const modal = document.getElementById("manage-group-modal");
          const container = document.getElementById("manage-group-members");
          container.innerHTML = "";
          const members = data.members ? Object.keys(data.members) : [];
          members.forEach((username) => {
            const div = document.createElement("div");
            div.className = "manage-member-item";
            const isOwner = username === data.owner;
            const safeName = (username || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            div.innerHTML = `
              <span>${safeName} ${isOwner ? "<span style='font-size:10px;opacity:0.7'>(owner)</span>" : ""}</span>
              <div style="display: flex; gap: 8px;">
                ${!isOwner ? `<button class="nexus-btn kick-btn" style="width:auto; padding:4px 12px; font-size:11px;">Kick</button>` : ""}
                ${!isOwner ? `<button class="nexus-btn promote-btn" style="width:auto; padding:4px 12px; font-size:11px; border-color: var(--online); color: var(--online);">Promote</button>` : ""}
              </div>
            `;
            if (!isOwner) {
              const kickBtn = div.querySelector(".kick-btn");
              const promoteBtn = div.querySelector(".promote-btn");
              if (kickBtn) kickBtn.onclick = () => kickGroupMember(activeChat, username);
              if (promoteBtn) promoteBtn.onclick = () => promoteGroupMember(activeChat, username);
            }
            container.appendChild(div);
          });
          modal.classList.add("show");
        });
      }

      function closeManageGroupModal() {
        document.getElementById("manage-group-modal").classList.remove("show");
      }

      function kickGroupMember(groupId, username) {
        if (!confirm(`Kick ${username} from the group?`)) return;
        db.ref("groups/" + groupId + "/members/" + username).remove();
      }

      function promoteGroupMember(groupId, username) {
        if (!confirm(`Make ${username} the group owner? You will become a regular member.`)) return;
        db.ref("groups/" + groupId).once("value", (snap) => {
          const data = snap.val();
          if (!data || data.owner !== window.myName) return;
          db.ref("groups/" + groupId).update({
            owner: username,
          });
          closeManageGroupModal();
        });
      }

      function createGroup() {
        const gn = prompt("Enter Group Name:");
        if (!gn) return;
        const gid = "group_" + Date.now();
        db.ref("groups/" + gid).set({
          name: gn,
          owner: window.myName,
          members: { [window.myName]: true, [activeChat]: true },
        });
        alert("Group Created!");
      }

      function listenGroups() {
        db.ref("groups").on("value", (snap) => {
          const box = document.getElementById("group-list");
          box.innerHTML = "";
          snap.forEach((g) => {
            const data = g.val();
            if (data.members && data.members[window.myName]) {
              const div = document.createElement("div");
            div.className = "contact-item";
            div.dataset.groupId = g.key;
            div.dataset.chatId = g.key;
              div.innerHTML = `
            <div class="avatar-circle" style="background:#222; text-align:center; line-height:34px;">G</div>
            <span style="flex:1">${data.name}</span>
            <button onclick="leaveGroup('${g.key}')" style="
              background:none;
              border:none;
              color:var(--alert);
              font-size:12px;
              cursor:pointer;
            ">‚úñ</button>
          `;

              div.onclick = () => openChat(g.key, div, "group");
              box.appendChild(div);
            }
          });
        });
      }

      function renderShop() {
  const container = document.getElementById("shop-items-container");
  container.innerHTML = "";
  const now = Date.now();

  // Separator: backgrounds
  container.innerHTML += `<div style="grid-column: 1/-1; color: var(--accent); font-size: 11px; letter-spacing: 3px; padding: 5px 0; border-bottom: 1px solid var(--border); margin-bottom: 5px;">üñºÔ∏è BACKGROUNDS</div>`;

  SHOP_ITEMS.forEach((item) => {
    if (item.type === "music") return;
    if (item.allowed && !item.allowed.includes(window.myName)) return;
    const isOwned = Array.isArray(myInventory) ? myInventory.includes(item.id) : false;
    container.innerHTML += `
      <div class="shop-item ${isOwned ? "owned" : ""}">
        <div class="bg-preview" style="background: url('${item.url}');"></div>
        <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${item.name}</div>
        <div style="font-size:12px; opacity:0.7; margin-bottom:10px;">${item.price} NC</div>
        <button class="nexus-btn ${isOwned ? "equip-btn" : ""}" onclick="${isOwned ? `equip('${item.url.replace(/'/g, "\\'")}')` : `buy('${item.id}', ${item.price})`}" ${!isOwned && myBalance < item.price ? "disabled" : ""}>
          ${isOwned ? "Equip" : "Purchase"}
        </button>
      </div>`;
  });

  // Limited items
  Object.keys(limitedShopItems).forEach((key) => {
    const item = limitedShopItems[key];
    const expiresAt = item.createdAt + item.durationMs;
    if (expiresAt <= now) return;
    const remainingMs = expiresAt - now;
    const timeLabel = formatRemainingTime(remainingMs);
    const isOwned = Array.isArray(myInventory) ? myInventory.includes(item.id) : false;
    const div = document.createElement("div");
    div.className = "shop-item" + (isOwned ? " owned" : "");
    div.innerHTML = `
      <div class="bg-preview" style="background: url('${(item.url || "").replace(/'/g, "%27")}');">
        <span class="limited-badge">LIMITED ${timeLabel}</span>
      </div>
      <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${(item.name || "").replace(/</g, "&lt;")}</div>
      <div style="font-size:12px; opacity:0.7; margin-bottom:10px;">${item.price} NC</div>
      <button class="nexus-btn ${isOwned ? "equip-btn" : ""}" ${!isOwned && myBalance < item.price ? "disabled" : ""}>
        ${isOwned ? "Equip" : "Purchase"}
      </button>`;
    const btn = div.querySelector("button");
    btn.onclick = () => isOwned ? equip(item.url) : buy(item.id, item.price);
    container.appendChild(div);
  });

  // Music section
  container.innerHTML += `<div style="grid-column: 1/-1; color: var(--accent); font-size: 11px; letter-spacing: 3px; padding: 5px 0; border-bottom: 1px solid var(--border); margin: 10px 0 5px 0;">üéµ PROFILE MUSIC</div>`;

  SHOP_ITEMS.forEach((item) => {
    if (item.type !== "music") return;
    const isOwned = Array.isArray(myInventory) ? myInventory.includes(item.id) : false;
    const div = document.createElement("div");
    div.className = "shop-item" + (isOwned ? " owned" : "");
    div.innerHTML = `
      <div class="bg-preview" style="background: #111; display:flex; align-items:center; justify-content:center; font-size: 40px;">üéµ</div>
      <div style="font-weight:bold; font-size:13px; margin-bottom:5px;">${item.name}</div>
      <div style="font-size:12px; opacity:0.7; margin-bottom:6px;">${item.price} NC</div>
      <button class="nexus-btn" id="preview-${item.id}" onclick="previewMusic('${item.audioUrl}', '${item.id}')" style="margin-bottom:6px; border-color:#888; color:#aaa; font-size:9px;">‚ñ∂ PREVIEW</button>
      <button class="nexus-btn ${isOwned ? "equip-btn" : ""}" ${!isOwned && myBalance < item.price ? "disabled" : ""}>
        ${isOwned ? "Equip Music" : "Purchase"}
      </button>`;
    const actionBtn = div.querySelectorAll("button")[1];
    actionBtn.onclick = () => isOwned ? equipMusic(item.audioUrl, item.id) : buy(item.id, item.price);
    container.appendChild(div);
  });
}

      function getItemById(id) {
        const fromShop = SHOP_ITEMS.find((i) => i.id === id);
        if (fromShop) return fromShop;
        const fromLimited = limitedShopItems[id];
        if (fromLimited) return fromLimited;
        return null;
      }

      function renderInventory() {
  const container = document.getElementById("inventory-items-container");
  if (!container) return;
  container.innerHTML = "";
  const ids = Array.isArray(myInventory) ? myInventory : [];

  const bgIds = ids.filter(id => {
    const item = getItemById(id);
    return item && item.type !== "music";
  });
  const musicIds = ids.filter(id => {
    const item = getItemById(id);
    return item && item.type === "music";
  });

  if (bgIds.length === 0 && musicIds.length === 0) {
    container.innerHTML = '<p style="opacity: 0.6; font-size: 14px;">No items yet. Buy some in the shop!</p>';
    return;
  }

  if (bgIds.length > 0) {
    container.innerHTML += `<div style="grid-column: 1/-1; color: var(--accent); font-size: 11px; letter-spacing: 3px; padding: 5px 0; border-bottom: 1px solid var(--border); margin-bottom: 5px;">üñºÔ∏è BACKGROUNDS</div>`;
    bgIds.forEach((id) => {
      const item = getItemById(id);
      if (!item) return;
      const div = document.createElement("div");
      div.className = "shop-item owned";
      div.innerHTML = `
        <div class="bg-preview" style="background: url('${(item.url || "").replace(/'/g, "%27")}');"></div>
        <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${(item.name || id).replace(/</g, "&lt;")}</div>
        <button class="nexus-btn equip-btn">Equip</button>`;
      div.querySelector("button").onclick = () => equip(item.url);
      container.appendChild(div);
    });
  }

  if (musicIds.length > 0) {
    const sep = document.createElement("div");
    sep.style.cssText = "grid-column: 1/-1; color: var(--accent); font-size: 11px; letter-spacing: 3px; padding: 5px 0; border-bottom: 1px solid var(--border); margin: 10px 0 5px 0;";
    sep.innerText = "üéµ PROFILE MUSIC";
    container.appendChild(sep);

    musicIds.forEach((id) => {
      const item = getItemById(id);
      if (!item) return;
      const div = document.createElement("div");
      div.className = "shop-item owned";
      div.innerHTML = `
        <div class="bg-preview" style="background:#111; display:flex; align-items:center; justify-content:center; font-size:40px;">üéµ</div>
        <div style="font-weight:bold; font-size:13px; margin-bottom:5px;">${(item.name || id).replace(/</g, "&lt;")}</div>
        <button class="nexus-btn" onclick="previewMusic('${item.audioUrl}', '${item.id}')" style="margin-bottom:6px; border-color:#888; color:#aaa; font-size:9px;">‚ñ∂ PREVIEW</button>
        <button class="nexus-btn equip-btn">Equip Music</button>`;
      div.querySelectorAll("button")[1].onclick = () => equipMusic(item.audioUrl, item.id);
      container.appendChild(div);
    });
  }
}

      function buy(id, price) {
        if (myBalance >= price) {
          db.ref("users/" + window.myName + "/balance").set(myBalance - price);
          myInventory.push(id);
          db.ref("users/" + window.myName + "/inventory").set(myInventory);
        }
      }

      function equip(url) {
        db.ref("users/" + window.myName + "/active_bg").set(url);
        alert("Background Synchronized.");
      }

      function handlePFP(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) =>
          db.ref("users/" + window.myName + "/pfp").set(e.target.result);
        reader.readAsDataURL(file);
      }

      function viewProfile(username) {
  tab("profile");
  document.getElementById("display-username").innerText = username;
  document.getElementById("pfp-edit-btn").style.display =
    username === window.myName ? "block" : "none";

// Show/hide trade & friend buttons
let existingActionBtns = document.getElementById("profile-action-btns");
if (existingActionBtns) existingActionBtns.remove();

if (username !== window.myName) {
  // Log this visit
  logProfileVisit(username);

  // Check if blocked
  db.ref("users/" + window.myName + "/blocked/" + username).once("value", (bSnap) => {
    const isBlocked = bSnap.val() === true;
    const actionDiv = document.createElement("div");
    actionDiv.id = "profile-action-btns";
    actionDiv.style.cssText = "display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;justify-content:center;";
    actionDiv.innerHTML = `
      <button class="nexus-btn" onclick="sendFriendRequestFromProfile('${username}')" style="width:auto;padding:7px 14px;font-size:10px;border-color:#00ff88;color:#00ff88;">+ Friend Request</button>
      <button class="nexus-btn" onclick="openTradeModal('${username}')" style="width:auto;padding:7px 14px;font-size:10px;border-color:#ff9900;color:#ff9900;">üîÑ Trade Request</button>
      <button class="nexus-btn" id="block-btn-${username}" onclick="toggleBlock('${username}')" style="width:auto;padding:7px 14px;font-size:10px;border-color:var(--alert);color:${isBlocked ? 'black' : 'var(--alert)'};background:${isBlocked ? 'var(--alert)' : 'transparent'};">${isBlocked ? 'üö´ Unblock' : 'üö´ Block'}</button>
    `;
    const card = document.querySelector(".profile-card-ui");
    const logoutBtn = card.querySelector(".logout-btn");
    card.insertBefore(actionDiv, logoutBtn.nextSibling);
  });

  // Hide my-only sections
  document.getElementById("bio-edit-section").style.display = "none";
  document.getElementById("visitor-log-section").style.display = "none";
  document.getElementById("blocked-section").style.display = "none";
} else {
  // Show bio editor
  document.getElementById("bio-edit-section").style.display = "block";
  // Load visitor log
  loadVisitorLog();
  // Show blocked users
  loadBlockedUsers();
}
  document.getElementById("pending-requests-section").style.display =
    username === window.myName ? "block" : "none";
    document.getElementById("group-invites-section").style.display =
    username === window.myName ? "block" : "none";
document.getElementById("trade-invites-section").style.display =
    username === window.myName ? "block" : "none";

  // Handle audio for dom's profile
  const audio = document.getElementById("profile-audio");
  console.log("Viewing profile:", username); // Debug log
  
  if (username === "dom") {
    audio.currentTime = 0;
    audio.play().catch(e => {});
  } else {
    audio.pause();
    audio.currentTime = 0;
  }

  // Stop any existing profile music first
  stopProfileMusic();

  // Load and play this user's equipped profile music
  db.ref("users/" + username + "/active_music").once("value", (mSnap) => {
    const musicUrl = mSnap.val();
    if (musicUrl) {
      playProfileMusic(musicUrl);
    }
  });

  db.ref("users/" + username).on("value", (snap) => {
    const data = snap.val();
    if (data) {
      document.getElementById("display-pfp").src =
        data.pfp || "https://via.placeholder.com/140?text=VOID";
      document.getElementById("profile-bg-layer").style.background =
        data.active_bg ? `url('${data.active_bg}')` : "#000";
      const isOnline = data.status === "online";
      document.getElementById("status-dot").className = `dot ${
        isOnline ? "online" : "offline"
      }`;
      document.getElementById("status-text").innerText = isOnline
        ? "ONLINE"
        : "OFFLINE";
      document.getElementById("status-text").style.color = isOnline
        ? "var(--online)"
        : "var(--offline)";
      
      // Display user tag (dom always has OWNER in red)
      const tagContainer = document.getElementById("display-tag");
      let userTag = getUserTag(username);
      if (!userTag && data.tag) {
        userTag = data.tag;
      }
      if (userTag) {
        tagContainer.innerHTML = `<span style="background: ${userTag.color}; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">${userTag.name}</span>`;
        tagContainer.style.display = "block";
      } else {
        tagContainer.style.display = "none";
      }
      // Bio
const bioEl = document.getElementById("display-bio");
if (data.bio) {
  bioEl.innerText = '"' + data.bio + '"';
  bioEl.style.display = "block";
} else {
  bioEl.style.display = "none";
}
// Pre-fill bio input if own profile
if (username === window.myName) {
  const bioInput = document.getElementById("bio-input");
  if (bioInput) bioInput.value = data.bio || "";
}
    }
  });
}

function tab(id) {
  document
    .querySelectorAll(".view, .nav-item")
    .forEach((v) => v.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  
  // Stop audio when switching away from profile
  if (id !== "profile") {
    const audio = document.getElementById("profile-audio");
    audio.pause();
    audio.currentTime = 0;
    stopProfileMusic();
    // Also stop any shop previews
    if (previewAudio) { previewAudio.pause(); previewAudio = null; }
  }
  
  if (id === "water")
    document.getElementById("water-frame").src =
      "https://cgxlyxnlynjpbmdiywnrc3rhcnrtewvkdwnhdglvbml0d2fzc29zawdtv2.familyguy.in/signin.html";
}

      function toggleWaterChat() {
        const sidebar = document.getElementById("water-sidebar");
        sidebar.style.display =
          sidebar.style.display === "flex" ? "none" : "flex";
      }

      function changeChatBG() {
        const url = prompt("Enter Image URL:");
        if (url)
          document.getElementById(
            "chat-pane"
          ).style.background = `url('${url}')`;
      }

      function unfriend(name) {
        if (!confirm(`Unfriend ${name}?`)) return;
        db.ref("users/" + window.myName + "/friends/" + name).remove();
        db.ref("users/" + name + "/friends/" + window.myName).remove();
        if (activeChat === name) {
          activeChat = null;
          chatType = "none";
          document.getElementById("active-chat-user").innerText =
            "Select a contact";
          document.getElementById("chat-msgs").innerHTML = "";
          document.getElementById("water-msgs").innerHTML = "";
        }
      }

      function leaveGroup(groupId) {
        if (!confirm("Leave this group?")) return;
        db.ref("groups/" + groupId + "/members/" + window.myName).remove();
        if (activeChat === groupId) {
          activeChat = null;
          chatType = "none";
          document.getElementById("active-chat-user").innerText =
            "Select a contact";
          document.getElementById("chat-msgs").innerHTML = "";
          document.getElementById("water-msgs").innerHTML = "";
        }
      }

      function renderMessage(box, key, d) {
        if (d.sender === "_system") {
          const div = document.createElement("div");
          div.className = "msg system";
          div.innerText = d.text;
          box.appendChild(div);
          return;
        }
        const isMe = d.sender === window.myName;
        const div = document.createElement("div");
        div.className = `msg ${isMe ? "user" : "other"}`;
        div.dataset.msgId = key;

// Check if message is a GIF
if (d.gif) {
  const isMe = d.sender === window.myName;
  const gifDiv = document.createElement("div");
  gifDiv.className = `msg ${isMe ? "user" : "other"}`;
  if (!isMe) {
    gifDiv.innerHTML = `
      <img class="chat-pfp-trigger" id="msg-pfp-${key}" src="https://via.placeholder.com/24" onclick="viewProfile('${d.sender}')">
      <span style="color:var(--accent);font-weight:bold;display:block;font-size:10px;">${d.sender}</span>
      <img class="msg-gif" src="${d.gif}" alt="GIF" />
    `;
    db.ref("users/" + d.sender + "/pfp").once("value", (pSnap) => {
      const img = document.getElementById(`msg-pfp-${key}`);
      if (img && pSnap.val()) img.src = pSnap.val();
    });
  } else {
    gifDiv.innerHTML = `
      <div style="font-size:10px;opacity:0.6;text-align:right;margin-bottom:3px;">${window.myName}</div>
      <img class="msg-gif" src="${d.gif}" alt="GIF" />
    `;
  }
  box.appendChild(gifDiv);
  return;
}

let messageText = d.text || "";
let mentionFound = false;

// Parse @mentions and make them blue and clickable
messageText = messageText.replace(/@([a-zA-Z0-9_]+)/g, (match, username) => {
          if (username.toLowerCase() === window.myName) {
            mentionFound = true;
          }
          return `<span class="mention" onclick="viewProfile('${username}')" style="color: #00008B; cursor: pointer; font-weight: bold;">${match}</span>`;
        });

        // Play notification sound if mentioned
        if (mentionFound && d.sender !== window.myName) {
          playMentionSound();
          showMentionNotification(d.sender, d.text);
        }

        // Build reply HTML if this is a reply
        let replyHtml = "";
        if (d.replyTo) {
          replyHtml = `
            <div class="reply-preview" style="font-size: 10px; opacity: 0.7; margin-bottom: 4px; padding: 4px; border-left: 2px solid var(--accent); background: rgba(0,242,255,0.1);">
              Replying to ${d.replyTo.sender}: ${d.replyTo.text.substring(0, 30)}${d.replyTo.text.length > 30 ? "..." : ""}
            </div>
          `;
        }

        // Reply button (visible on hover for non-system messages)
        const replyButton = `
          <button class="reply-btn" onclick="startReply('${key}', '${d.sender}', '${(d.text || "").replace(/'/g, "\\'")}')" style="position: absolute; right: -25px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--accent); cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 14px;" title="Reply">
            ‚Ü©
          </button>
        `;

        if (!isMe) {
          div.style.position = "relative";
          // Get tag for the sender (dom always has OWNER)
          const senderTag = getUserTag(d.sender) || d.senderTag;
          const tagHtml = senderTag ? 
            `<span style="background: ${senderTag.color}; color: white; padding: 1px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px; text-transform: uppercase;">${senderTag.name}</span>` : 
            '';
          div.innerHTML = `
            <img class="chat-pfp-trigger" id="msg-pfp-${key}" src="https://via.placeholder.com/24"
              onclick="viewProfile('${d.sender}')">
            <span style="color:var(--accent); font-weight:bold; display:block; font-size:10px;">
              ${d.sender}${tagHtml}
            </span>
            ${replyHtml}
            ${messageText}
            ${replyButton}
          `;

          db.ref("users/" + d.sender + "/pfp").once("value", (pSnap) => {
            const img = document.getElementById(`msg-pfp-${key}`);
            if (img && pSnap.val()) img.src = pSnap.val();
          });
          
          // Load tag from Firebase if not dom
          if (d.sender !== "dom") {
            db.ref("users/" + d.sender + "/tag").once("value", (tSnap) => {
              const tag = tSnap.val();
              if (tag) {
                const senderSpan = div.querySelector("span");
                if (senderSpan && !senderSpan.querySelector("span")) {
                  const tagSpan = document.createElement("span");
                  tagSpan.style.cssText = `background: ${tag.color}; color: white; padding: 1px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px; text-transform: uppercase;`;
                  tagSpan.innerText = tag.name;
                  senderSpan.appendChild(tagSpan);
                }
              }
            });
          }
        } else {
          div.style.position = "relative";
          // Get my tag (dom always has OWNER)
          const myTag = getUserTag(window.myName);
          const tagHtml = myTag ? 
            `<span style="background: ${myTag.color}; color: white; padding: 1px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px; text-transform: uppercase;">${myTag.name}</span>` : 
            '';
          div.innerHTML = `
            <div style="font-size:10px; opacity:0.6; text-align:right; margin-bottom:3px;">
              ${window.myName}${tagHtml}
            </div>
            ${replyHtml}
            ${messageText}
            <div style="font-size:10px; opacity:0.6; text-align:right; margin-top:3px;">
              ${d.seen && Object.keys(d.seen).length > 1 ? "Seen" : "Sent"}
            </div>
            ${replyButton}
          `;
          
          // Load tag from Firebase if not dom
          if (window.myName !== "dom") {
            db.ref("users/" + window.myName + "/tag").once("value", (tSnap) => {
              const tag = tSnap.val();
              if (tag) {
                const nameDiv = div.querySelector("div");
                if (nameDiv && !nameDiv.querySelector("span")) {
                  const tagSpan = document.createElement("span");
                  tagSpan.style.cssText = `background: ${tag.color}; color: white; padding: 1px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px; text-transform: uppercase;`;
                  tagSpan.innerText = tag.name;
                  nameDiv.appendChild(tagSpan);
                }
              }
            });
          }
        }

        // Show reply button on hover
        div.addEventListener("mouseenter", () => {
          const btn = div.querySelector(".reply-btn");
          if (btn) btn.style.opacity = "1";
        });
        div.addEventListener("mouseleave", () => {
          const btn = div.querySelector(".reply-btn");
          if (btn) btn.style.opacity = "0";
        });

        box.appendChild(div);
      }

      // Reply functionality
      let currentReply = null;

      function startReply(msgId, sender, text) {
        currentReply = { msgId, sender, text };
        const inputId = activeChat === "water" ? "water-chat-input" : "chat-input";
        const input = document.getElementById(inputId);
        
        // Show reply preview above input
        let replyPreview = document.getElementById("reply-preview");
        if (!replyPreview) {
          replyPreview = document.createElement("div");
          replyPreview.id = "reply-preview";
          replyPreview.style.cssText = "background: rgba(0,242,255,0.1); padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;";
          input.parentElement.insertBefore(replyPreview, input);
        }
        
        replyPreview.innerHTML = `
          <span>Replying to ${sender}: ${text.substring(0, 40)}${text.length > 40 ? "..." : ""}</span>
          <button onclick="cancelReply()" style="background: none; border: none; color: var(--alert); cursor: pointer; font-size: 14px;">‚úï</button>
        `;
        replyPreview.style.display = "flex";
        
        input.focus();
      }

      function cancelReply() {
        currentReply = null;
        const replyPreview = document.getElementById("reply-preview");
        if (replyPreview) replyPreview.style.display = "none";
      }

      // Play mention notification sound
      function playMentionSound() {
        try {
          const audio = new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTijMGHm7A7+OZSA0PVanu8LdnHgU2k9n1unEiBCuBzvXWiTYJHGm98+OZ");
          audio.volume = 0.5;
          audio.play().catch(() => {});
        } catch (e) {}
      }

      // Show mention notification
      function showMentionNotification(sender, text) {
        const notif = document.getElementById("message-notification");
        if (notif) {
          notif.innerHTML = `<strong>${sender} mentioned you!</strong><br><small>${text.substring(0, 50)}${text.length > 50 ? "..." : ""}</small>`;
          notif.classList.add("show");
          setTimeout(() => notif.classList.remove("show"), 5000);
        }
      }

      // Update sendMsg to include reply info
      const originalSendMsg = sendMsg;
      sendMsg = function(source) {
        const inputId = source === "water" ? "water-chat-input" : "chat-input";
        const inp = document.getElementById(inputId);
        if (!activeChat || !inp.value.trim()) return;

        const text = inp.value;
        
        // Character limit check
        const MAX_LENGTH = 212;
        if (text.length > MAX_LENGTH) {
          alert(`Message too long! Maximum ${MAX_LENGTH} characters allowed.`);
          return;
        }
        
        inp.value = "";

        const chatId =
          chatType === "global"
            ? "GLOBAL_CHAT"
            : chatType === "group"
            ? activeChat
            : [window.myName, activeChat].sort().join("_");
            
        const messageData = {
          sender: window.myName,
          text,
          timestamp: Date.now(),
          seen: { [window.myName]: true },
        };
        
        // Add reply info if replying
        if (currentReply) {
          messageData.replyTo = currentReply;
          cancelReply();
        }
            
        db.ref("messages/" + chatId).push(messageData);
      };

      function markMessagesSeen(chatId) {
        db.ref("messages/" + chatId)
          .limitToLast(50)
          .once("value", (snap) => {
            snap.forEach((m) => {
              const d = m.val();
              if (!d.seen || !d.seen[window.myName]) {
                db.ref(
                  "messages/" + chatId + "/" + m.key + "/seen/" + window.myName
                ).set(true);
              }
            });
          });
      }
      function switchAccount(targetAccount) {
        localStorage.setItem("nexus_user", targetAccount);
        window.myName = targetAccount;
        location.reload();
      }

      function banUser() {
        if (window.myName !== "dom") return;
        const username = document.getElementById("ban-username-input").value.trim().toLowerCase();
        const feedback = document.getElementById("ban-feedback");
        if (!username) {
          feedback.innerText = "Enter a username";
          return;
        }
        if (username === "dom") {
          feedback.innerText = "You can't ban yourself";
          return;
        }
        db.ref("banned/" + username).set(true).then(() => {
          feedback.innerText = username + " has been banned.";
          document.getElementById("ban-username-input").value = "";
        }).catch(() => {
          feedback.innerText = "Failed to ban.";
        });
      }
      function logout() {
  if (confirm("Are you sure you want to log out?")) {
    // Set status to offline before leaving
    db.ref("users/" + window.myName + "/status").set("offline").then(() => {
      localStorage.removeItem("nexus_user");
      location.reload();
    });
  }
}

      // Leaderboard functions
      let leaderboardInterval = null;
      
      function updateLeaderboards() {
        updateCreditsLeaderboard();
        updateTimeLeaderboard();
        updateBackgroundsLeaderboard();
      }
      
      function updateCreditsLeaderboard() {
        db.ref("users").once("value", (snap) => {
          const users = [];
          snap.forEach((child) => {
            const userData = child.val();
            // Exclude users with > 50,000 coins and dom
            if (userData.balance && child.key !== "dom" && userData.balance <= 50000) {
              users.push({ name: child.key, credits: userData.balance });
            }
          });
          
          users.sort((a, b) => b.credits - a.credits);
          const top5 = users.slice(0, 5);
          
          const container = document.getElementById("credits-leaderboard");
          container.innerHTML = "";
          
          if (top5.length === 0) {
            container.innerHTML = "<div style='text-align: center; color: var(--accent); padding: 20px;'>No users with credits yet</div>";
            return;
          }
          
          top5.forEach((user, index) => {
            const div = document.createElement("div");
            div.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid var(--border);";
            div.innerHTML = `
              <span style="color: ${index < 3 ? 'var(--accent)' : 'white'}; font-weight: ${index < 3 ? 'bold' : 'normal'};">
                ${index + 1}. ${user.name}
              </span>
              <span style="color: var(--online); font-weight: bold;">${user.credits} NC</span>
            `;
            container.appendChild(div);
            
            // Award winner.png skin to top 5
            if (index < 5) {
              awardWinnerSkin(user.name);
            }
          });
        });
      }
      
      function updateTimeLeaderboard() {
        db.ref("users").once("value", (snap) => {
          const users = [];
          snap.forEach((child) => {
            const userData = child.val();
            // Check for various possible time tracking fields
            const timeValue = userData.timePlayed || userData.totalTime || userData.sessionTime || 0;
            if (timeValue && child.key !== "dom") {
              users.push({ name: child.key, time: timeValue });
            }
          });
          
          users.sort((a, b) => b.time - a.time);
          const top5 = users.slice(0, 5);
          
          const container = document.getElementById("time-leaderboard");
          container.innerHTML = "";
          
          if (top5.length === 0) {
            container.innerHTML = "<div style='text-align: center; color: var(--accent); padding: 20px;'>No time data available yet</div>";
            return;
          }
          
          top5.forEach((user, index) => {
            const hours = Math.floor(user.time / 3600);
            const minutes = Math.floor((user.time % 3600) / 60);
            const timeStr = `${hours}h ${minutes}m`;
            
            const div = document.createElement("div");
            div.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid var(--border);";
            div.innerHTML = `
              <span style="color: ${index < 3 ? 'var(--accent)' : 'white'}; font-weight: ${index < 3 ? 'bold' : 'normal'};">
                ${index + 1}. ${user.name}
              </span>
              <span style="color: var(--online); font-weight: bold;">${timeStr}</span>
            `;
            container.appendChild(div);
            
            // Award winner.png skin to top 5
            if (index < 5) {
              awardWinnerSkin(user.name);
            }
          });
        });
      }
      
      function updateBackgroundsLeaderboard() {
        db.ref("users").once("value", (snap) => {
          const users = [];
          snap.forEach((child) => {
            const userData = child.val();
            if (userData.inventory && child.key !== "dom") {
              const bgCount = Object.keys(userData.inventory).filter(key => userData.inventory[key]).length;
              users.push({ name: child.key, count: bgCount });
            }
          });
          
          users.sort((a, b) => b.count - a.count);
          const top5 = users.slice(0, 5);
          
          const container = document.getElementById("backgrounds-leaderboard");
          container.innerHTML = "";
          
          top5.forEach((user, index) => {
            const div = document.createElement("div");
            div.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid var(--border);";
            div.innerHTML = `
              <span style="color: ${index < 3 ? 'var(--accent)' : 'white'}; font-weight: ${index < 3 ? 'bold' : 'normal'};">
                ${index + 1}. ${user.name}
              </span>
              <span style="color: var(--online); font-weight: bold;">${user.count} backgrounds</span>
            `;
            container.appendChild(div);
            
            // Award winner.png skin to top 5
            if (index < 5) {
              awardWinnerSkin(user.name);
            }
          });
        });
      }
      
      function awardWinnerSkin(username) {
        // Award the winner.png skin to top 5 leaderboard users
        db.ref("users/" + username + "/inventory/winner.png").set(true).then(() => {
          console.log(`Awarded winner.png skin to ${username}`);
        }).catch((error) => {
          console.error("Failed to award winner.png skin:", error);
        });
      }
      
      // Start leaderboard updates when tab is opened
      const originalTab = tab;
      tab = function(id) {
        originalTab(id);
        
        if (id === 'admin') {
          loadAdminGamesList();
        }
        
        if (id === 'games') {
          loadGames();
        }  
        
        if (id === 'leaderboards') {
          updateLeaderboards();
          if (leaderboardInterval) clearInterval(leaderboardInterval);
          leaderboardInterval = setInterval(updateLeaderboards, 10000); // Update every 10 seconds
        } else {
          if (leaderboardInterval) {
            clearInterval(leaderboardInterval);
            leaderboardInterval = null;
          }
        }
      };
      
      // --- SLOT MACHINE FUNCTIONS ---
      const slotSymbols = ['üíé', 'üçÄ', '7Ô∏è‚É£', 'üé∞', 'üí∞', '‚≠ê', 'üéØ', 'üî•'];
      let freeSpinning = false;
      let betSpinning = false;
      let userLuck = 1; // Default luck multiplier (1 = normal)
      
      // Load user's luck from Firebase
      function loadUserLuck() {
        if (!window.myName) return;
        db.ref('users/' + window.myName + '/luck').on('value', (snap) => {
          userLuck = snap.val() || 1;
        });
      }
      
      function getRandomSymbol() {
        return slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
      }
      
      // Weighted random for free slot with higher win chance
      function getFreeSlotSymbols() {
        // 40% base chance to win, multiplied by user luck
        const winChance = Math.min(0.4 * userLuck, 0.8); // Cap at 80%
        
        if (Math.random() < winChance) {
          // Force a win - all three match
          const winningSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
          return [winningSymbol, winningSymbol, winningSymbol];
        } else {
          // Random but ensure they don't all match
          let symbols;
          do {
            symbols = [getRandomSymbol(), getRandomSymbol(), getRandomSymbol()];
          } while (symbols[0] === symbols[1] && symbols[1] === symbols[2]);
          return symbols;
        }
      }
      
      // Weighted random for betting slot with normal win chance + luck bonus
      function getBetSlotSymbols() {
        // 25% base chance to win, multiplied by user luck
        const winChance = Math.min(0.25 * userLuck, 0.7); // Cap at 70%
        
        if (Math.random() < winChance) {
          // Force a win - all three match
          const winningSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
          return [winningSymbol, winningSymbol, winningSymbol];
        } else {
          // Random but ensure they don't all match
          let symbols;
          do {
            symbols = [getRandomSymbol(), getRandomSymbol(), getRandomSymbol()];
          } while (symbols[0] === symbols[1] && symbols[1] === symbols[2]);
          return symbols;
        }
      }
      
      function spinFreeSlot() {
        if (freeSpinning) return;
        freeSpinning = true;
        
        const btn = document.getElementById('free-spin-btn');
        const result = document.getElementById('free-result');
        const reels = [
          document.getElementById('free-reel-1'),
          document.getElementById('free-reel-2'),
          document.getElementById('free-reel-3')
        ];
        const display = document.getElementById('free-slot-display');
        
        btn.disabled = true;
        btn.style.opacity = '0.5';
        result.textContent = '';
        display.classList.remove('win');
        reels.forEach(r => r.classList.remove('win'));
        
        // Get predetermined result with weighted odds
        const finalSymbols = getFreeSlotSymbols();
        
        // Spin animation
        let spins = 0;
        const maxSpins = 20;
        const interval = setInterval(() => {
          reels.forEach(reel => {
            reel.textContent = getRandomSymbol();
            reel.classList.add('spinning');
          });
          spins++;
          
          if (spins >= maxSpins) {
            clearInterval(interval);
            reels.forEach(r => r.classList.remove('spinning'));
            
            // Set final predetermined result
            reels.forEach((reel, index) => {
              reel.textContent = finalSymbols[index];
            });
            
            // Check if all match (win)
            const allMatch = finalSymbols.every(s => s === finalSymbols[0]);
            
            if (allMatch) {
              result.innerHTML = '<span style="color: var(--accent);">‚ú® PRACTICE WIN! ‚ú®</span>';
              display.classList.add('win');
              reels.forEach(r => r.classList.add('win'));
            } else {
              result.textContent = 'Try again!';
            }
            
            freeSpinning = false;
            btn.disabled = false;
            btn.style.opacity = '1';
          }
        }, 100);
      }
      
      // Update bet display when input changes - attach when gambling tab is opened
      function attachBetListener() {
        const betInput = document.getElementById('bet-amount');
        if (betInput && !betInput.dataset.listenerAttached) {
          betInput.addEventListener('input', function() {
            document.getElementById('current-bet').textContent = this.value;
          });
          betInput.dataset.listenerAttached = 'true';
        }
      }
      
      function spinBetSlot() {
        if (betSpinning) return;
        
        const betAmount = parseInt(document.getElementById('bet-amount').value) || 100;
        if (betAmount < 10) {
          alert('Minimum bet is 10 credits');
          return;
        }
        if (betAmount > myBalance) {
          alert('Insufficient credits!');
          return;
        }
        
        betSpinning = true;
        
        const btn = document.getElementById('bet-spin-btn');
        const result = document.getElementById('bet-result');
        const reels = [
          document.getElementById('bet-reel-1'),
          document.getElementById('bet-reel-2'),
          document.getElementById('bet-reel-3')
        ];
        const display = document.getElementById('bet-slot-display');
        
        // Deduct bet
        myBalance -= betAmount;
        db.ref('users/' + window.myName + '/balance').set(myBalance);
        
        btn.disabled = true;
        btn.style.opacity = '0.5';
        result.textContent = '';
        display.classList.remove('win');
        reels.forEach(r => r.classList.remove('win'));
        
        // Get predetermined result with weighted odds
        const finalSymbols = getBetSlotSymbols();
        
        // Spin animation
        let spins = 0;
        const maxSpins = 20;
        const interval = setInterval(() => {
          reels.forEach(reel => {
            reel.textContent = getRandomSymbol();
            reel.classList.add('spinning');
          });
          spins++;
          
          if (spins >= maxSpins) {
            clearInterval(interval);
            reels.forEach(r => r.classList.remove('spinning'));
            
            // Set final predetermined result
            reels.forEach((reel, index) => {
              reel.textContent = finalSymbols[index];
            });
            
            // Check win
            const allMatch = finalSymbols.every(s => s === finalSymbols[0]);
            const symbol = finalSymbols[0];
            
            let winnings = 0;
            let winText = '';
            
            if (allMatch) {
              if (symbol === 'üíé') {
                winnings = betAmount * 3;
                winText = `üíéüíéüíé TRIPLE WIN! +${winnings} credits!`;
              } else if (symbol === 'üçÄ') {
                winnings = betAmount * 2;
                winText = `üçÄüçÄüçÄ DOUBLE WIN! +${winnings} credits!`;
              } else if (symbol === '7Ô∏è‚É£') {
                winnings = betAmount * 5;
                winText = `7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£ JACKPOT! +${winnings} credits!`;
              } else {
                winnings = betAmount * 2;
                winText = `Matched! +${winnings} credits!`;
              }
              
              // Add winnings
              myBalance += winnings;
              db.ref('users/' + window.myName + '/balance').set(myBalance);
              
              result.innerHTML = `<span style="color: var(--online); font-weight: bold;">${winText}</span>`;
              display.classList.add('win');
              reels.forEach(r => r.classList.add('win'));
              
              // Show money popup
              showMoneyPopup(winnings);
            } else {
              result.innerHTML = `<span style="color: var(--alert);">You lost ${betAmount} credits. Try again!</span>`;
            }
            
            betSpinning = false;
            btn.disabled = false;
            btn.style.opacity = '1';
          }
        }, 100);
      }
      
      function showMoneyPopup(amount) {
        const popup = document.getElementById('money-pop');
        if (popup) {
          popup.textContent = `+${amount} credits!`;
          popup.style.display = 'block';
          setTimeout(() => {
            popup.style.display = 'none';
          }, 2000);
        }
      }
      
      // Play a game
      function launchGame(gameId, gameName, gameUrl) {
        // Load game in same tab
        const gameContent = document.getElementById('game-content');
        
        // Hide game selection, show game
        gameContent.style.display = 'none';
        
        // Create game iframe
        const gameFrame = document.createElement('iframe');
        gameFrame.src = gameUrl;
        gameFrame.style.cssText = 'width: 100%; height: 100%; border: none; background: #000;';
        
        // Add game to content area
        gameContent.innerHTML = '';
        gameContent.appendChild(gameFrame);
        gameContent.style.display = 'flex';
        
        // Update header
        document.querySelector('#games span').textContent = gameName;
      }
      
      // Return to games selection
      function returnToGamesSelection() {
        const gameContent = document.getElementById('game-content');
        
        // Hide game, show game selection
        gameContent.style.display = 'none';
        
        // Restore game selection
        gameContent.innerHTML = `
          <h2 style="letter-spacing: 3px; margin-bottom: 30px;">select a game</h2>
          <div id="games-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 100%; max-width: 1000px;">
            <!-- retro bowl -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">retro</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">retro</h3>
                <button class="nexus-btn" onclick="launchGame('retro bowl', 'retro bowl', 'Retro Bowl.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
            
            <!-- Game 2 -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #2e1a2e 0%, #1e1621 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">epstein</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">stein island</h3>
                <button class="nexus-btn" onclick="launchGame('game2', 'Game 2', 'stein.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
            
            <!-- Game 3 -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #1e2e1e 0%, #162116 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">buster</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">buster jam</h3>
                <button class="nexus-btn" onclick="launchGame('game3', 'Game 3', 'Buster Jam.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
            <!-- Game 4 -->
            <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; cursor: pointer;">
              <div style="height: 150px; background: linear-gradient(135deg, #2e1a2e 0%, #1e1621 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                <span style="font-size: 48px;">cattle</span>
              </div>
              <div style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">crazy cattle</h3>
                <button class="nexus-btn" onclick="launchGame('game2', 'Game 2', 'Crazy Cattle 3D.html')" style="width: 100%; margin-top: auto; padding: 10px; font-size: 12px;">
                  ‚ñ∂ Play
                </button>
              </div>
            </div>
          </div>
        `;
        gameContent.style.display = 'flex';
        
        // Update header
        document.querySelector('#games span').textContent = 'games';
      }
      // --- PROFILE MUSIC ---
let previewAudio = null;

function previewMusic(audioUrl, itemId) {
  // Stop any existing preview
  if (previewAudio) {
    previewAudio.pause();
    previewAudio = null;
    // Reset all preview buttons
    document.querySelectorAll('[id^="preview-"]').forEach(btn => {
      btn.innerText = "‚ñ∂ PREVIEW";
      btn.style.color = "#aaa";
    });
  }
  const btn = document.getElementById("preview-" + itemId);
  if (btn && btn.innerText === "‚èπ STOP") return; // toggle off

  previewAudio = new Audio(audioUrl);
  previewAudio.volume = 0.5;
  previewAudio.play().catch(() => {});
  previewAudio.onended = () => {
    if (btn) { btn.innerText = "‚ñ∂ PREVIEW"; btn.style.color = "#aaa"; }
    previewAudio = null;
  };
  if (btn) { btn.innerText = "‚èπ STOP"; btn.style.color = "var(--accent)"; }
}

function equipMusic(audioUrl, itemId) {
  // Stop preview if playing
  if (previewAudio) { previewAudio.pause(); previewAudio = null; }
  db.ref("users/" + window.myName + "/active_music").set(audioUrl);
  alert("Profile music equipped!");
}

function playProfileMusic(audioUrl) {
  const player = document.getElementById("profile-music-player");
  if (!player) return;
  if (player.src && player.src.endsWith(audioUrl) && !player.paused) return; // already playing
  player.src = audioUrl;
  player.currentTime = 0;
  player.play().catch(() => {});
}

function stopProfileMusic() {
  const player = document.getElementById("profile-music-player");
  if (!player) return;
  player.pause();
  player.currentTime = 0;
  player.src = "";
}
// --- MEMBERS PANEL ---
let membersPanelListener = null;
let membersPanelStatusListeners = {};

function openMembersPanel() {
  const panel = document.getElementById("members-panel");
  const backdrop = document.getElementById("members-panel-backdrop");
  const title = document.getElementById("members-panel-title");
  panel.style.right = "0";
  backdrop.style.display = "block";

  // Clear previous listeners
  cleanupMembersPanel();

  if (chatType === "global") {
    title.innerText = "LIVE CHATROOM";
    loadAllUsersAsMembers();
  } else if (chatType === "group") {
    title.innerText = "GROUP MEMBERS";
    loadGroupMembers(activeChat);
  } else if (chatType === "private") {
    title.innerText = "CONTACT";
    loadPrivateMembers(activeChat);
  }
}

function closeMembersPanel() {
  document.getElementById("members-panel").style.right = "-320px";
  document.getElementById("members-panel-backdrop").style.display = "none";
  cleanupMembersPanel();
}

function cleanupMembersPanel() {
  // Detach global users listener if it was attached
  db.ref("users").off("value");

  // Detach all per-user status listeners
  Object.keys(membersPanelStatusListeners).forEach(username => {
    db.ref("users/" + username + "/status").off("value");
  });
  membersPanelStatusListeners = {};

  document.getElementById("members-online-list").innerHTML = "";
  document.getElementById("members-offline-list").innerHTML = "";
}

function loadGroupMembers(groupId) {
  db.ref("groups/" + groupId).once("value", (snap) => {
    const data = snap.val();
    if (!data || !data.members) return;
    const members = Object.keys(data.members);
    renderMembersList(members);
  });
}

function loadPrivateMembers(otherUser) {
  // Show yourself + the contact
  renderMembersList([window.myName, otherUser]);
}

function loadAllUsersAsMembers() {
  // Listen in real time so new users joining show up live
  db.ref("users").on("value", (snap) => {
    const members = [];
    snap.forEach(child => members.push(child.key));
    renderMembersList(members);
  });
}
function renderMembersList(usernames) {
  const onlineList = document.getElementById("members-online-list");
  const offlineList = document.getElementById("members-offline-list");
  onlineList.innerHTML = "";
  offlineList.innerHTML = "";

  usernames.forEach(username => {
    // Create placeholder elements for both lists
    const onlineEl = buildMemberEl(username, true);
    const offlineEl = buildMemberEl(username, false);

    // Listen to status in real time
    const statusRef = db.ref("users/" + username + "/status");
    membersPanelStatusListeners[username] = statusRef;

    // Load pfp once
    db.ref("users/" + username + "/pfp").once("value", pfpSnap => {
      const pfp = pfpSnap.val() || "https://via.placeholder.com/32";
      const imgs = [
        document.getElementById("mpfp-online-" + username),
        document.getElementById("mpfp-offline-" + username)
      ];
      imgs.forEach(img => { if (img) img.src = pfp; });
    });

    statusRef.on("value", snap => {
      const isOnline = snap.val() === "online";
      if (isOnline) {
        if (!onlineList.contains(onlineEl)) {
          onlineList.appendChild(onlineEl);
          if (offlineList.contains(offlineEl)) offlineList.removeChild(offlineEl);
        }
      } else {
        if (!offlineList.contains(offlineEl)) {
          offlineList.appendChild(offlineEl);
          if (onlineList.contains(onlineEl)) onlineList.removeChild(onlineEl);
        }
      }
    });
  });
}

function buildMemberEl(username, isOnline) {
  const div = document.createElement("div");
  div.className = "member-item" + (!isOnline ? " offline-member" : "");
  div.onclick = () => { closeMembersPanel(); viewProfile(username); };

  const statusColor = isOnline ? "#00ff88" : "#444";
  const suffix = isOnline ? "online" : "offline";

  div.innerHTML = `
    <img id="mpfp-${suffix}-${username}" class="member-pfp" src="https://via.placeholder.com/32" />
    <span class="member-name">${username}</span>
    <div class="member-status-dot" style="background:${statusColor};${isOnline ? "box-shadow:0 0 6px #00ff88;" : ""}"></div>
  `;
  return div;
}
// --- GIF PICKER ---
// Replace with your Giphy API key from developers.giphy.com (free)
const GIPHY_API_KEY = "8gobBXWBuxbqA7Ko3G3l4oacWLbMcdgH";
let gifSearchTimeout = null;

function openGifModal() {
  if (!activeChat) return;
  const modal = document.getElementById("gif-modal");
  modal.style.display = "flex";
  document.getElementById("gif-search-input").focus();
  // Load trending GIFs by default
  loadTrendingGifs();
}

function closeGifModal() {
  document.getElementById("gif-modal").style.display = "none";
  document.getElementById("gif-search-input").value = "";
  document.getElementById("gif-results").innerHTML = '<div id="gif-placeholder" style="grid-column:1/-1;text-align:center;opacity:0.4;padding:40px;font-size:13px;">Search for a GIF above</div>';
}

function loadTrendingGifs() {
  const results = document.getElementById("gif-results");
  const loading = document.getElementById("gif-loading");
  results.innerHTML = "";
  loading.style.display = "block";

  fetch(`https://api.giphy.com/v1/gifs/trending?api_key=8gobBXWBuxbqA7Ko3G3l4oacWLbMcdgH&limit=18&rating=pg-13`)
    .then(r => r.json())
    .then(data => {
      loading.style.display = "none";
      renderGifResults(data.data || []);
    })
    .catch(() => {
      loading.style.display = "none";
      results.innerHTML = '<div style="grid-column:1/-1;text-align:center;opacity:0.4;padding:40px;font-size:13px;">Failed to load GIFs. Check your API key.</div>';
    });
}

function searchGifs() {
  const query = document.getElementById("gif-search-input").value.trim();
  if (!query) { loadTrendingGifs(); return; }

  const results = document.getElementById("gif-results");
  const loading = document.getElementById("gif-loading");
  results.innerHTML = "";
  loading.style.display = "block";

  fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=18&rating=pg-13`)
    .then(r => r.json())
    .then(data => {
      loading.style.display = "none";
      renderGifResults(data.data || []);
    })
    .catch(() => {
      loading.style.display = "none";
      results.innerHTML = '<div style="grid-column:1/-1;text-align:center;opacity:0.4;padding:40px;font-size:13px;">Search failed. Try again.</div>';
    });
}

function renderGifResults(gifs) {
  const results = document.getElementById("gif-results");
  results.innerHTML = "";
  if (gifs.length === 0) {
    results.innerHTML = '<div style="grid-column:1/-1;text-align:center;opacity:0.4;padding:40px;font-size:13px;">No GIFs found.</div>';
    return;
  }
  gifs.forEach(gif => {
    const url = gif.images.fixed_height_small.url;
    const original = gif.images.original.url;
    const img = document.createElement("img");
    img.className = "gif-thumb";
    img.src = url;
    img.loading = "lazy";
    img.onclick = () => sendGif(original);
    results.appendChild(img);
  });
}

function sendGif(gifUrl) {
  if (!activeChat) return;
  closeGifModal();

  const chatId =
    chatType === "global"
      ? "GLOBAL_CHAT"
      : chatType === "group"
      ? activeChat
      : [window.myName, activeChat].sort().join("_");

  db.ref("messages/" + chatId).push({
    sender: window.myName,
    gif: gifUrl,
    text: "",
    timestamp: Date.now(),
    seen: { [window.myName]: true },
  });
}
// --- TRADING SYSTEM ---
let tradeTarget = null;
let tradeOffer = { credits: 0, bgs: [], music: [] };
let tradeWant = { credits: 0, bgs: [], music: [] };
let pickerMode = { type: null, side: null };

function sendFriendRequestFromProfile(username) {
  if (username === window.myName) return;
  db.ref("requests/" + username + "/" + window.myName).set(true);
  alert("Friend request sent to " + username + "!");
}

function openTradeModal(username) {
  tradeTarget = username;
  tradeOffer = { credits: 0, bgs: [], music: [] };
  tradeWant = { credits: 0, bgs: [], music: [] };
  document.getElementById("trade-target-name").innerText = username;
  document.getElementById("trade-my-credits").value = "";
  document.getElementById("trade-their-credits").value = "";
  document.getElementById("trade-my-bgs").innerHTML = "";
  document.getElementById("trade-my-music").innerHTML = "";
  document.getElementById("trade-their-bgs").innerHTML = "";
  document.getElementById("trade-their-music").innerHTML = "";
  document.getElementById("trade-modal").style.display = "flex";
}

function closeTradeModal() {
  document.getElementById("trade-modal").style.display = "none";
  tradeTarget = null;
}

function openTradeItemPicker(type, side) {
  pickerMode = { type, side };
  const title = document.getElementById("picker-title");
  const items = document.getElementById("picker-items");
  items.innerHTML = "";

  title.innerText = (type === "bg" ? "SELECT BACKGROUND" : "SELECT MUSIC") + " ‚Äî " + (side === "my" ? "YOUR OFFER" : "YOU WANT");

  // For "my" side, show items from MY inventory
  // For "their" side, show items from TARGET's inventory
  const userToCheck = side === "my" ? window.myName : tradeTarget;

  db.ref("users/" + userToCheck + "/inventory").once("value", (snap) => {
    const inv = snap.val() || [];
    const invArr = Array.isArray(inv) ? inv : Object.keys(inv);

    const filtered = invArr.filter(id => {
      const item = getItemById(id);
      if (!item) return false;
      if (type === "bg") return item.type !== "music";
      if (type === "music") return item.type === "music";
      return false;
    });

    if (filtered.length === 0) {
      items.innerHTML = `<div style="grid-column:1/-1;text-align:center;opacity:0.4;padding:30px;font-size:12px;">${userToCheck} has no ${type === "bg" ? "backgrounds" : "music"} to trade.</div>`;
      document.getElementById("trade-picker-modal").style.display = "flex";
      return;
    }

    filtered.forEach(id => {
      const item = getItemById(id);
      if (!item) return;

      // Check if already added
      const alreadyAdded = side === "my"
        ? (type === "bg" ? tradeOffer.bgs.includes(id) : tradeOffer.music.includes(id))
        : (type === "bg" ? tradeWant.bgs.includes(id) : tradeWant.music.includes(id));

      const div = document.createElement("div");
      div.style.cssText = `background:rgba(255,255,255,0.04);border:1px solid ${alreadyAdded ? "var(--online)" : "rgba(255,255,255,0.1)"};border-radius:8px;padding:10px;cursor:pointer;text-align:center;transition:0.2s;`;
      div.innerHTML = `
        <div style="width:100%;height:70px;background:${item.type === "music" ? "#111" : `url('${item.url || ""}') center/cover`};border-radius:4px;margin-bottom:6px;display:flex;align-items:center;justify-content:center;font-size:28px;">${item.type === "music" ? "üéµ" : ""}</div>
        <div style="font-size:10px;font-weight:bold;margin-bottom:4px;">${item.name || id}</div>
        <div style="font-size:9px;color:${alreadyAdded ? "var(--online)" : "rgba(255,255,255,0.4)"};">${alreadyAdded ? "‚úì Added" : "Click to add"}</div>
      `;
      div.onclick = () => {
        if (alreadyAdded) return;
        if (side === "my") {
          if (type === "bg") tradeOffer.bgs.push(id);
          else tradeOffer.music.push(id);
        } else {
          if (type === "bg") tradeWant.bgs.push(id);
          else tradeWant.music.push(id);
        }
        refreshTradeOfferUI();
        closeTradePickerModal();
      };
      items.appendChild(div);
    });

    document.getElementById("trade-picker-modal").style.display = "flex";
  });
}

function closeTradePickerModal() {
  document.getElementById("trade-picker-modal").style.display = "none";
}

function refreshTradeOfferUI() {
  renderTradeItems("trade-my-bgs", tradeOffer.bgs, "bg", "my");
  renderTradeItems("trade-my-music", tradeOffer.music, "music", "my");
  renderTradeItems("trade-their-bgs", tradeWant.bgs, "bg", "their");
  renderTradeItems("trade-their-music", tradeWant.music, "music", "their");
}

function renderTradeItems(containerId, ids, type, side) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  ids.forEach(id => {
    const item = getItemById(id);
    if (!item) return;
    const pill = document.createElement("div");
    pill.style.cssText = "background:rgba(0,242,255,0.1);border:1px solid var(--accent);border-radius:20px;padding:4px 10px;font-size:10px;display:flex;align-items:center;gap:6px;";
    pill.innerHTML = `
      <span>${item.type === "music" ? "üéµ" : "üñºÔ∏è"} ${item.name || id}</span>
      <span onclick="removeTradeItem('${id}','${type}','${side}')" style="cursor:pointer;color:var(--alert);font-size:12px;line-height:1;">‚úï</span>
    `;
    container.appendChild(pill);
  });
}

function removeTradeItem(id, type, side) {
  if (side === "my") {
    if (type === "bg") tradeOffer.bgs = tradeOffer.bgs.filter(x => x !== id);
    else tradeOffer.music = tradeOffer.music.filter(x => x !== id);
  } else {
    if (type === "bg") tradeWant.bgs = tradeWant.bgs.filter(x => x !== id);
    else tradeWant.music = tradeWant.music.filter(x => x !== id);
  }
  refreshTradeOfferUI();
}

function sendTradeRequest() {
  if (!tradeTarget) return;
  const myCredits = parseInt(document.getElementById("trade-my-credits").value) || 0;
  const theirCredits = parseInt(document.getElementById("trade-their-credits").value) || 0;

  if (myCredits > myBalance) {
    alert("You don't have enough credits to offer that!");
    return;
  }
  if (myCredits === 0 && theirCredits === 0 && tradeOffer.bgs.length === 0 && tradeOffer.music.length === 0 && tradeWant.bgs.length === 0 && tradeWant.music.length === 0) {
    alert("Add something to the trade first!");
    return;
  }

  const tradeData = {
    from: window.myName,
    to: tradeTarget,
    offer: { credits: myCredits, bgs: tradeOffer.bgs, music: tradeOffer.music },
    want: { credits: theirCredits, bgs: tradeWant.bgs, music: tradeWant.music },
    timestamp: Date.now(),
    status: "pending"
  };

  const tradeId = "trade_" + Date.now();
  db.ref("tradeInvites/" + tradeTarget + "/" + tradeId).set(tradeData).then(() => {
    db.ref("notifications/" + tradeTarget).push({
      text: window.myName + " sent you a trade request!",
      from: window.myName,
      timestamp: Date.now()
    });
    closeTradeModal();
    alert("Trade request sent to " + tradeTarget + "!");
  });
}

function listenTradeInvites() {
  db.ref("tradeInvites/" + window.myName).on("value", (snap) => {
    const container = document.getElementById("trade-invites-container");
    if (!container) return;
    container.innerHTML = "";
    let count = 0;

    snap.forEach((inv) => {
      const data = inv.val();
      if (!data || data.status !== "pending") return;
      count++;
      const tradeId = inv.key;

      const div = document.createElement("div");
      div.style.cssText = "background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;margin-top:8px;font-size:11px;";

      // Build summary
      const offerParts = [];
      if (data.offer.credits > 0) offerParts.push(data.offer.credits + " credits");
      (data.offer.bgs || []).forEach(id => {
        const item = getItemById(id);
        offerParts.push("üñºÔ∏è " + (item ? item.name : id));
      });
      (data.offer.music || []).forEach(id => {
        const item = getItemById(id);
        offerParts.push("üéµ " + (item ? item.name : id));
      });

      const wantParts = [];
      if (data.want.credits > 0) wantParts.push(data.want.credits + " credits");
      (data.want.bgs || []).forEach(id => {
        const item = getItemById(id);
        wantParts.push("üñºÔ∏è " + (item ? item.name : id));
      });
      (data.want.music || []).forEach(id => {
        const item = getItemById(id);
        wantParts.push("üéµ " + (item ? item.name : id));
      });

      div.innerHTML = `
        <div style="font-weight:bold;color:var(--accent);margin-bottom:6px;">Trade from ${data.from}</div>
        <div style="margin-bottom:4px;"><span style="opacity:0.6;">They offer:</span> ${offerParts.length ? offerParts.join(", ") : "nothing"}</div>
        <div style="margin-bottom:8px;"><span style="opacity:0.6;">They want:</span> ${wantParts.length ? wantParts.join(", ") : "nothing"}</div>
        <div style="display:flex;gap:6px;">
          <button class="nexus-btn" onclick="acceptTrade('${tradeId}')" style="width:auto;padding:5px 14px;font-size:10px;border-color:var(--online);color:var(--online);">Accept</button>
          <button class="nexus-btn" onclick="declineTrade('${tradeId}')" style="width:auto;padding:5px 14px;font-size:10px;border-color:var(--alert);color:var(--alert);">Decline</button>
        </div>
      `;
      container.appendChild(div);
    });

    const section = document.getElementById("trade-invites-section");
    if (section) section.style.display = count > 0 ? "block" : "none";
  });
}

function acceptTrade(tradeId) {
  db.ref("tradeInvites/" + window.myName + "/" + tradeId).once("value", (snap) => {
    const data = snap.val();
    if (!data) return;

    const them = data.from;

    // Validate both sides still have the items/credits
    db.ref("users/" + window.myName).once("value", (mySnap) => {
      db.ref("users/" + them).once("value", (themSnap) => {
        const myData = mySnap.val() || {};
        const themData = themSnap.val() || {};
        const myBal = myData.balance || 0;
        const themBal = themData.balance || 0;
        const myInv = Array.isArray(myData.inventory) ? myData.inventory : [];
        const themInv = Array.isArray(themData.inventory) ? themData.inventory : [];

        // Validate credits
        if ((data.want.credits || 0) > myBal) { alert("You don't have enough credits!"); return; }
        if ((data.offer.credits || 0) > themBal) { alert("They no longer have enough credits!"); return; }

        // Validate items still owned
        for (const id of (data.want.bgs || [])) {
          if (!myInv.includes(id)) { alert("You no longer own: " + id); return; }
        }
        for (const id of (data.want.music || [])) {
          if (!myInv.includes(id)) { alert("You no longer own: " + id); return; }
        }
        for (const id of (data.offer.bgs || [])) {
          if (!themInv.includes(id)) { alert("They no longer own: " + id); return; }
        }
        for (const id of (data.offer.music || [])) {
          if (!themInv.includes(id)) { alert("They no longer own: " + id); return; }
        }

        // Execute trade
        let myNewBal = myBal - (data.want.credits || 0) + (data.offer.credits || 0);
        let themNewBal = themBal - (data.offer.credits || 0) + (data.want.credits || 0);

        // Transfer inventory items
        let myNewInv = [...myInv];
        let themNewInv = [...themInv];

        // They give me their offer items
        (data.offer.bgs || []).forEach(id => {
          if (!myNewInv.includes(id)) myNewInv.push(id);
          themNewInv = themNewInv.filter(x => x !== id);
        });
        (data.offer.music || []).forEach(id => {
          if (!myNewInv.includes(id)) myNewInv.push(id);
          themNewInv = themNewInv.filter(x => x !== id);
        });

        // I give them what they want
        (data.want.bgs || []).forEach(id => {
          if (!themNewInv.includes(id)) themNewInv.push(id);
          myNewInv = myNewInv.filter(x => x !== id);
        });
        (data.want.music || []).forEach(id => {
          if (!themNewInv.includes(id)) themNewInv.push(id);
          myNewInv = myNewInv.filter(x => x !== id);
        });

        // Write all changes atomically
        const updates = {
          [`users/${window.myName}/balance`]: myNewBal,
          [`users/${window.myName}/inventory`]: myNewInv,
          [`users/${them}/balance`]: themNewBal,
          [`users/${them}/inventory`]: themNewInv,
          [`tradeInvites/${window.myName}/${tradeId}/status`]: "accepted",
        };

        db.ref().update(updates, (err) => {
          if (err) { alert("Trade failed! Try again."); return; }
          db.ref("notifications/" + them).push({
            text: window.myName + " accepted your trade!",
            from: window.myName,
            timestamp: Date.now()
          });
          db.ref("tradeInvites/" + window.myName + "/" + tradeId).remove();
          alert("Trade completed successfully!");
        });
      });
    });
  });
}

function declineTrade(tradeId) {
  db.ref("tradeInvites/" + window.myName + "/" + tradeId).once("value", (snap) => {
    const data = snap.val();
    db.ref("tradeInvites/" + window.myName + "/" + tradeId).remove();
    if (data && data.from) {
      db.ref("notifications/" + data.from).push({
        text: window.myName + " declined your trade request.",
        from: window.myName,
        timestamp: Date.now()
      });
    }
  });
}
// --- BIO ---
function saveBio() {
  const bio = (document.getElementById("bio-input").value || "").trim().substring(0, 120);
  db.ref("users/" + window.myName + "/bio").set(bio).then(() => {
    alert("Bio saved!");
  });
}

// --- BLOCK SYSTEM ---
function toggleBlock(username) {
  db.ref("users/" + window.myName + "/blocked/" + username).once("value", (snap) => {
    if (snap.val() === true) {
      // Unblock
      db.ref("users/" + window.myName + "/blocked/" + username).remove().then(() => {
        const btn = document.getElementById("block-btn-" + username);
        if (btn) {
          btn.innerText = "üö´ Block";
          btn.style.background = "transparent";
          btn.style.color = "var(--alert)";
        }
      });
    } else {
      // Block
      if (!confirm("Block " + username + "? They won't be able to message you or view your profile.")) return;
      db.ref("users/" + window.myName + "/blocked/" + username).set(true).then(() => {
        const btn = document.getElementById("block-btn-" + username);
        if (btn) {
          btn.innerText = "üö´ Unblock";
          btn.style.background = "var(--alert)";
          btn.style.color = "black";
        }
      });
    }
  });
}

function loadBlockedUsers() {
  const section = document.getElementById("blocked-section");
  const container = document.getElementById("blocked-list-container");
  db.ref("users/" + window.myName + "/blocked").on("value", (snap) => {
    container.innerHTML = "";
    let count = 0;
    snap.forEach(child => {
      count++;
      const username = child.key;
      const div = document.createElement("div");
      div.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;";
      div.innerHTML = `
        <span style="opacity:0.7;">${username}</span>
        <button class="nexus-btn" onclick="toggleBlock('${username}')" style="width:auto;padding:3px 10px;font-size:10px;border-color:var(--online);color:var(--online);">Unblock</button>
      `;
      container.appendChild(div);
    });
    section.style.display = count > 0 ? "block" : "none";
  });
}

// Block check ‚Äî call before opening a chat
function isUserBlocked(username, callback) {
  db.ref("users/" + window.myName + "/blocked/" + username).once("value", (snap) => {
    callback(snap.val() === true);
  });
}

// --- VISITOR LOG ---
function logProfileVisit(profileOwner) {
  if (!window.myName || window.myName === profileOwner) return;
  const visitData = {
    visitor: window.myName,
    timestamp: Date.now()
  };
  // Store under the profile owner's visitors, keyed by visitor name so it overwrites old visits
  db.ref("users/" + profileOwner + "/visitors/" + window.myName).set(visitData);
}

function loadVisitorLog() {
  const section = document.getElementById("visitor-log-section");
  const list = document.getElementById("visitor-log-list");
  db.ref("users/" + window.myName + "/visitors").orderByChild("timestamp").limitToLast(10).once("value", (snap) => {
    list.innerHTML = "";
    const visitors = [];
    snap.forEach(child => visitors.push(child.val()));
    visitors.reverse(); // Most recent first

    if (visitors.length === 0) {
      list.innerHTML = '<div style="font-size:11px;opacity:0.4;">No visitors yet.</div>';
      section.style.display = "block";
      return;
    }

    visitors.forEach(v => {
      const timeAgo = getTimeAgo(v.timestamp);
      const div = document.createElement("div");
      div.style.cssText = "display:flex;align-items:center;gap:10px;cursor:pointer;padding:5px 0;border-bottom:1px solid var(--border);";
      div.innerHTML = `
        <img id="vlog-pfp-${v.visitor}" src="https://via.placeholder.com/28" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border);" />
        <span style="flex:1;font-size:12px;">${v.visitor}</span>
        <span style="font-size:10px;opacity:0.4;">${timeAgo}</span>
      `;
      div.onclick = () => viewProfile(v.visitor);
      list.appendChild(div);

      db.ref("users/" + v.visitor + "/pfp").once("value", (pSnap) => {
        const img = document.getElementById("vlog-pfp-" + v.visitor);
        if (img && pSnap.val()) img.src = pSnap.val();
      });
    });

    section.style.display = "block";
  });
}

function getTimeAgo(timestamp) {
  const diff = Date.now() - timestamp;
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  if (mins < 1) return "just now";
  if (mins < 60) return mins + "m ago";
  if (hours < 24) return hours + "h ago";
  return days + "d ago";
}

// --- USER SEARCH ---
let searchUsersTimeout = null;
let allUsersCache = null;

function searchUsers() {
  const query = document.getElementById("user-search-input").value.trim().toLowerCase();
  const results = document.getElementById("user-search-results");

  clearTimeout(searchUsersTimeout);
  searchUsersTimeout = setTimeout(() => {
    if (!query) {
      results.innerHTML = '<div style="opacity:0.4;font-size:13px;text-align:center;padding:20px;">Type to search users...</div>';
      return;
    }

    // Fetch all users and filter client-side
    db.ref("users").once("value", (snap) => {
      results.innerHTML = "";
      const matches = [];
      snap.forEach(child => {
        if (child.key.includes(query) && child.key !== window.myName) {
          matches.push({ username: child.key, data: child.val() });
        }
      });

      if (matches.length === 0) {
        results.innerHTML = '<div style="opacity:0.4;font-size:13px;text-align:center;padding:20px;">No users found.</div>';
        return;
      }

      matches.forEach(({ username, data }) => {
        const isOnline = data.status === "online";
        const div = document.createElement("div");
        div.style.cssText = "display:flex;align-items:center;gap:12px;padding:12px 15px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;transition:0.2s;";
        div.onmouseover = () => div.style.borderColor = "var(--accent)";
        div.onmouseout = () => div.style.borderColor = "rgba(255,255,255,0.08)";
        div.onclick = () => viewProfile(username);

        // Tag badges
        let tagHtml = "";
        if (username === "dom") {
          tagHtml = `<span style="background:#ff0000;color:white;padding:1px 7px;border-radius:3px;font-size:9px;text-transform:uppercase;font-weight:bold;">OWNER</span>`;
        } else if (data.tag) {
          tagHtml = `<span style="background:${data.tag.color};color:white;padding:1px 7px;border-radius:3px;font-size:9px;text-transform:uppercase;font-weight:bold;">${data.tag.name}</span>`;
        }
        if (data.staffTag && (!data.tag || data.tag.name !== data.staffTag.name)) {
          tagHtml += `<span style="background:${data.staffTag.color};color:white;padding:1px 7px;border-radius:3px;font-size:9px;text-transform:uppercase;font-weight:bold;margin-left:3px;">${data.staffTag.name}</span>`;
        }

        div.innerHTML = `
          <img src="${data.pfp || 'https://via.placeholder.com/40'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid ${isOnline ? 'var(--online)' : '#333'};" />
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
              <span style="font-size:13px;font-weight:bold;">${username}</span>
              ${tagHtml}
            </div>
            <div style="font-size:11px;opacity:0.5;">${data.bio ? '"' + data.bio + '"' : 'No bio'}</div>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div style="width:8px;height:8px;border-radius:50%;background:${isOnline ? 'var(--online)' : '#444'};${isOnline ? 'box-shadow:0 0 6px var(--online);' : ''}"></div>
            <span style="font-size:10px;color:${isOnline ? 'var(--online)' : '#444'};">${isOnline ? 'online' : 'offline'}</span>
          </div>
        `;
        results.appendChild(div);
      });
    });
  }, 300);
}
    </script>
  </body>
</html>
